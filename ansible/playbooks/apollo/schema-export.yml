# Export Apollo Federation subgraph schemas
# ansible-playbook playbooks/apollo/schema-export.yml
---
- name: Export Apollo Federation subgraph schemas
  hosts: localhost
  connection: local
  become: false
  gather_facts: false

  vars:
    # Project directories
    project_root: "{{ root_dir }}"
    schema_dir: "{{ playbook_dir }}/schema"
    schema_output_arg: "{{ root_dir }}/ansible/playbooks/apollo/schema"

  tasks:
    - name: Export schemas block with error handling
      block:
        - name: Export subgraph schemas
          ansible.builtin.include_tasks: tasks/schema-export.yml

        - name: Show success message
          ansible.builtin.debug:
            msg:
              - "ðŸŽ‰ Apollo Federation subgraph schemas exported successfully!"
              - ""
              - "ðŸ“ Schemas location: {{ schema_dir }}"
              - ""
              - "ðŸ’¡ Next steps:"
              - "  1. Update supergraph.yaml files to reference these schemas"
              - "  2. Run 'ansible-playbook playbooks/apollo/local.yml' to compose supergraphs"

      rescue:
        - name: Show error details
          ansible.builtin.debug:
            msg:
              - "âŒ Schema export failed!"
              - "Task: {{ ansible_failed_task.name | default('Unknown') }}"
              - "Error: {{ ansible_failed_result.msg | default('No message') }}"
              - "{% if ansible_failed_result.stderr is defined and ansible_failed_result.stderr | length > 0 %}Stderr: {{ ansible_failed_result.stderr }}{% endif %}"
              - "{% if ansible_failed_result.stdout is defined and ansible_failed_result.stdout | length > 0 %}Stdout: {{ ansible_failed_result.stdout }}{% endif %}"

        - name: Fail with message
          ansible.builtin.fail:
            msg: "Schema export failed. See error details above."
