# Deploy Apollo Router services locally
# Local variables are loaded from vars.local.yml
# ansible-playbook playbooks/apollo/local.yml
---
- name: Build and deploy Apollo Router services locally
  hosts: localhost
  connection: local
  become: false
  gather_facts: false

  vars_files:
    - vars/vars.local.yml

  vars:
    # Local build directory
    local_build_dir: "{{ root_dir }}"

    # Apollo configuration paths
    config_dir: "{{ playbook_dir }}/config"
    schema_dir: "{{ playbook_dir }}/schema"
    runtime_dir: "{{ playbook_dir }}/runtime"

    # Image configuration with 'local' tag
    rover_app_name: shopana/apollo-rover
    rover_image_tag: local
    rover_image_name: "{{ rover_app_name }}:{{ rover_image_tag }}"
    rover_build_context: "{{ root_dir }}/apollo/rover"

    router_app_name: shopana/apollo-router
    router_image_tag: local
    router_image_name: "{{ router_app_name }}:{{ router_image_tag }}"
    router_build_context: "{{ root_dir }}/apollo/router"

    # Supergraph configuration
    admin_api_config_path: "{{ runtime_dir }}/config/supergraph-admin.yaml"
    admin_api_output_path: "{{ runtime_dir }}/config/supergraph-admin.graphql"

    storefront_api_config_path: "{{ runtime_dir }}/config/supergraph-storefront.yaml"
    storefront_api_output_path: "{{ runtime_dir }}/config/supergraph-storefront.graphql"

    # Docker compose
    compose_file: "{{ runtime_dir }}/docker-compose.yml"

  tasks:
    - name: Display deployment start message
      ansible.builtin.debug:
        msg:
          - "ðŸš€ Starting local Apollo Router deployment"
          - "ðŸ“ Working directory: {{ local_build_dir }}"

    - name: Build block with error handling
      block:
        - name: Export subgraph schemas
          ansible.builtin.include_tasks: tasks/schema-export.yml
          vars:
            project_root: "{{ local_build_dir }}"
            schema_output_arg: "{{ root_dir }}/ansible/playbooks/apollo/schema"

        - name: Check if Rover image exists
          ansible.builtin.command:
            cmd: docker image inspect {{ rover_image_name }}
          register: rover_check
          ignore_errors: true
          changed_when: false

        - name: Display Rover image status
          ansible.builtin.debug:
            msg: "{{ 'âœ… Using existing Apollo Rover image: ' + rover_image_name if rover_check.rc == 0 else 'ðŸ”¨ Building Apollo Rover image: ' + rover_image_name }}"

        - name: Build apollo-rover image if needed
          ansible.builtin.command:
            cmd: docker build --platform {{ docker_platform }} -t {{ rover_image_name }} {{ rover_build_context }}
            chdir: "{{ local_build_dir }}"
          when: rover_check.rc != 0
          changed_when: true

        - name: Check if Router image exists
          ansible.builtin.command:
            cmd: docker image inspect {{ router_image_name }}
          register: router_check
          ignore_errors: true
          changed_when: false

        - name: Display Router image status
          ansible.builtin.debug:
            msg: "{{ 'âœ… Using existing Apollo Router image: ' + router_image_name if router_check.rc == 0 else 'ðŸ”¨ Building Apollo Router image: ' + router_image_name }}"

        - name: Build apollo-router image if needed
          ansible.builtin.command:
            cmd: docker build --platform {{ docker_platform }} -t {{ router_image_name }} {{ router_build_context }}
            chdir: "{{ local_build_dir }}"
          when: router_check.rc != 0
          changed_when: true

        - name: Create runtime directories
          ansible.builtin.file:
            path: "{{ item }}"
            state: directory
            mode: "0755"
          loop:
            - "{{ runtime_dir }}"
            - "{{ runtime_dir }}/config"
            - "{{ runtime_dir }}/config/schema"

        - name: Copy schema files to runtime directory
          ansible.builtin.copy:
            src: "{{ schema_dir }}/"
            dest: "{{ runtime_dir }}/config/schema/"
            mode: "0644"

        - name: Generate docker-compose.yml from template
          ansible.builtin.template:
            src: "{{ config_dir }}/docker-compose.yml.j2"
            dest: "{{ compose_file }}"
            mode: "0644"

        - name: Generate router-admin.yaml from template
          ansible.builtin.template:
            src: "{{ config_dir }}/admin/router-admin.yaml.j2"
            dest: "{{ runtime_dir }}/config/router-admin.yaml"
            mode: "0644"

        - name: Generate router-storefront.yaml from template
          ansible.builtin.template:
            src: "{{ config_dir }}/storefront/router-storefront.yaml.j2"
            dest: "{{ runtime_dir }}/config/router-storefront.yaml"
            mode: "0644"

        - name: Compose supergraph schemas
          ansible.builtin.include_tasks: tasks/schema-compose.yml
          vars:
            output_dir: "{{ runtime_dir }}/config"

        - name: Stop existing Apollo Router services
          ansible.builtin.command:
            cmd: docker compose down
            chdir: "{{ runtime_dir }}"
          ignore_errors: true
          changed_when: false

        - name: Start Apollo Router services with Docker Compose
          ansible.builtin.command:
            cmd: docker compose up -d --force-recreate
            chdir: "{{ runtime_dir }}"
          changed_when: true

        - name: Wait for Admin Router to be healthy
          ansible.builtin.command:
            cmd: curl -f -s http://localhost:{{ apollo_router_admin_health_port }}/health
          register: admin_health
          until: admin_health.rc == 0
          retries: 30
          delay: 2
          ignore_errors: true
          changed_when: false

        - name: Wait for Storefront Router to be healthy
          ansible.builtin.command:
            cmd: curl -f -s http://localhost:{{ apollo_router_storefront_health_port }}/health
          register: storefront_health
          until: storefront_health.rc == 0
          retries: 30
          delay: 2
          ignore_errors: true
          changed_when: false

        - name: Show success message
          ansible.builtin.debug:
            msg:
              - "âœ… Apollo Router services deployed successfully!"
              - ""
              - "ðŸ“¦ Images:"
              - "  - {{ rover_image_name }}"
              - "  - {{ router_image_name }}"
              - ""
              - "ðŸ”— Services:"
              - "  - Admin API:      http://localhost:{{ apollo_router_admin_port }}/api/admin/graphql/query"
              - "  - Admin Health:   http://localhost:{{ apollo_router_admin_health_port }}/health"
              - "  - Storefront API: http://localhost:{{ apollo_router_storefront_port }}/api/client/graphql/query"
              - "  - Storefront Health: http://localhost:{{ apollo_router_storefront_health_port }}/health"
              - ""
              - "ðŸ“„ Schemas:"
              - "  - {{ admin_api_output_path }}"
              - "  - {{ storefront_api_output_path }}"

      rescue:
        - name: Show error details
          ansible.builtin.debug:
            msg:
              - "âŒ Deployment failed!"
              - "Task: {{ ansible_failed_task.name | default('Unknown') }}"
              - "Error: {{ ansible_failed_result.msg | default('No message') }}"
              - "{% if ansible_failed_result.stderr is defined and ansible_failed_result.stderr | length > 0 %}Stderr: {{ ansible_failed_result.stderr }}{% endif %}"

        - name: Stop services on failure
          ansible.builtin.command:
            cmd: docker compose down
            chdir: "{{ runtime_dir }}"
          ignore_errors: true
          changed_when: false

        - name: Fail with message
          ansible.builtin.fail:
            msg: "Local deployment failed. See error details above."
