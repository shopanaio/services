services:
  router-admin:
    image: ghcr.io/shopanaio/apollo-router:${APOLLO_ROUTER_TAG:-latest}
    container_name: shopana-apollo-admin
    restart: unless-stopped
    ports:
      - "0.0.0.0:{{ apollo_router_admin_port }}:{{ apollo_router_admin_port }}"
      - "0.0.0.0:{{ apollo_router_admin_metrics_port }}:{{ apollo_router_admin_metrics_port }}"
      - "0.0.0.0:{{ apollo_router_admin_health_port }}:{{ apollo_router_admin_health_port }}"
    volumes:
      - ./config/router-admin.yaml:/dist/config/router.yaml:ro
      - ./config/supergraph-admin.graphql:/dist/schema/supergraph.graphql:ro
    environment:
      APOLLO_ROUTER_CONFIG_PATH: /dist/config/router.yaml
      APOLLO_ROUTER_SUPERGRAPH_PATH: /dist/schema/supergraph.graphql
      APOLLO_ELV2_LICENSE: accept
    command:
      - --supergraph
      - /dist/schema/supergraph.graphql
      - --config
      - /dist/config/router.yaml
    networks:
      - shopana-network
    labels:
      - "com.docker.compose.project=apollo-router"
      - "com.docker.compose.service=router-admin"
      - "traefik.enable=true"
      # GraphQL endpoint
      - "traefik.http.routers.apollo-admin.rule=PathPrefix(`/api/admin/graphql`)"
      - "traefik.http.routers.apollo-admin.entrypoints=web"
      - "traefik.http.routers.apollo-admin.priority=10"
      # Homepage
      - "traefik.http.routers.apollo-admin-home.rule=Host(`138.199.239.105`) && PathPrefix(`/admin/router`)"
      - "traefik.http.routers.apollo-admin-home.entrypoints=web"
      - "traefik.http.routers.apollo-admin-home.priority=9"
      - "traefik.http.routers.apollo-admin-home.middlewares=apollo-admin-strip"
      # Service definition
      - "traefik.http.services.apollo-admin.loadbalancer.server.port={{ apollo_router_admin_port }}"
      # Middleware to strip prefix for homepage
      - "traefik.http.middlewares.apollo-admin-strip.stripprefix.prefixes=/admin/router"

  router-storefront:
    image: ghcr.io/shopanaio/apollo-router:${APOLLO_ROUTER_TAG:-latest}
    container_name: shopana-apollo-storefront
    restart: unless-stopped
    ports:
      - "0.0.0.0:{{ apollo_router_storefront_port }}:{{ apollo_router_storefront_port }}"
      - "0.0.0.0:{{ apollo_router_storefront_metrics_port }}:{{ apollo_router_storefront_metrics_port }}"
      - "0.0.0.0:{{ apollo_router_storefront_health_port }}:{{ apollo_router_storefront_health_port }}"
    volumes:
      - ./config/router-storefront.yaml:/dist/config/router.yaml:ro
      - ./config/supergraph-storefront.graphql:/dist/schema/supergraph.graphql:ro
    environment:
      APOLLO_ROUTER_CONFIG_PATH: /dist/config/router.yaml
      APOLLO_ROUTER_SUPERGRAPH_PATH: /dist/schema/supergraph.graphql
      APOLLO_ELV2_LICENSE: accept
    command:
      - --supergraph
      - /dist/schema/supergraph.graphql
      - --config
      - /dist/config/router.yaml
    networks:
      - shopana-network
    labels:
      - "com.docker.compose.project=apollo-router"
      - "com.docker.compose.service=router-storefront"
      - "traefik.enable=true"
      # GraphQL endpoint
      - "traefik.http.routers.apollo-storefront.rule=PathPrefix(`/api/client/graphql`)"
      - "traefik.http.routers.apollo-storefront.entrypoints=web"
      - "traefik.http.routers.apollo-storefront.priority=10"
      # Homepage
      - "traefik.http.routers.apollo-storefront-home.rule=Host(`138.199.239.105`) && PathPrefix(`/storefront/router`)"
      - "traefik.http.routers.apollo-storefront-home.entrypoints=web"
      - "traefik.http.routers.apollo-storefront-home.priority=9"
      - "traefik.http.routers.apollo-storefront-home.middlewares=apollo-storefront-strip"
      # Service definition
      - "traefik.http.services.apollo-storefront.loadbalancer.server.port={{ apollo_router_storefront_port }}"
      # Middleware to strip prefix for homepage
      - "traefik.http.middlewares.apollo-storefront-strip.stripprefix.prefixes=/storefront/router"

networks:
  shopana-network:
    name: shopana-network
    external: true
