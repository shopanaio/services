# Manage Woodpecker CI
# ansible-playbook playbooks/woodpecker-ci/manage.yml -e "action=start"
# ansible-playbook playbooks/woodpecker-ci/manage.yml -e "action=stop"
# ansible-playbook playbooks/woodpecker-ci/manage.yml -e "action=restart"
# ansible-playbook playbooks/woodpecker-ci/manage.yml -e "action=status"
# ansible-playbook playbooks/woodpecker-ci/manage.yml -e "action=logs"
# ansible-playbook playbooks/woodpecker-ci/manage.yml -e "action=version"
# ansible-playbook playbooks/woodpecker-ci/manage.yml -e "action=upgrade"
# ansible-playbook playbooks/woodpecker-ci/manage.yml -e "action=diagnose"
---
- name: Manage Woodpecker CI
  hosts: shopana
  become: true
  gather_facts: false

  vars:
    woodpecker_dir: /opt/woodpecker
    action: status

  tasks:
    - name: Verify Woodpecker directory exists
      ansible.builtin.stat:
        path: "{{ woodpecker_dir }}/docker-compose.yml"
      register: compose_file

    - name: Fail if Woodpecker is not installed
      ansible.builtin.fail:
        msg: "Woodpecker is not installed at {{ woodpecker_dir }}. Run playbooks/woodpecker-ci/install.yml first."
      when: not compose_file.stat.exists

    - name: Start Woodpecker CI
      ansible.builtin.command:
        cmd: docker compose up -d
        chdir: "{{ woodpecker_dir }}"
      when: action == 'start'
      changed_when: true

    - name: Stop Woodpecker CI
      ansible.builtin.command:
        cmd: docker compose down
        chdir: "{{ woodpecker_dir }}"
      when: action == 'stop'
      changed_when: true

    - name: Restart Woodpecker CI
      ansible.builtin.command:
        cmd: docker compose restart
        chdir: "{{ woodpecker_dir }}"
      when: action == 'restart'
      changed_when: true

    - name: Pull latest Woodpecker images
      ansible.builtin.command:
        cmd: docker compose pull
        chdir: "{{ woodpecker_dir }}"
      when: action == 'upgrade'
      changed_when: true

    - name: Recreate and start Woodpecker CI (upgrade)
      ansible.builtin.command:
        cmd: docker compose up -d
        chdir: "{{ woodpecker_dir }}"
      when: action == 'upgrade'
      changed_when: true

    - name: Get Woodpecker status
      ansible.builtin.command:
        cmd: docker compose ps
        chdir: "{{ woodpecker_dir }}"
      register: status_output
      changed_when: false
      when: action in ['status', 'start', 'restart', 'diagnose', 'version', 'upgrade']

    - name: Display status
      ansible.builtin.debug:
        var: status_output.stdout_lines
      when:
        - action in ['status', 'start', 'restart', 'diagnose', 'version', 'upgrade']
        - status_output is defined

    - name: Get Woodpecker logs
      ansible.builtin.command:
        cmd: docker compose logs --tail=100
        chdir: "{{ woodpecker_dir }}"
      register: logs_output
      changed_when: false
      when: action in ['logs', 'diagnose']

    - name: Display logs
      ansible.builtin.debug:
        var: logs_output.stdout_lines
      when:
        - action in ['logs', 'diagnose']
        - logs_output is defined

    - name: Show .env content
      ansible.builtin.command:
        cmd: cat .env
        chdir: "{{ woodpecker_dir }}"
      register: env_output
      changed_when: false
      when: action == 'diagnose'

    - name: Display .env
      ansible.builtin.debug:
        var: env_output.stdout_lines
      when:
        - action == 'diagnose'
        - env_output is defined

    - name: Show compose images
      ansible.builtin.command:
        cmd: docker compose images
        chdir: "{{ woodpecker_dir }}"
      register: images_output
      changed_when: false
      when: action in ['version', 'diagnose']

    - name: Detect server image reference
      ansible.builtin.command:
        cmd: docker inspect -f '{{"{{"}}.Config.Image{{"}}"}}' woodpecker-server
      register: server_image_ref
      changed_when: false
      failed_when: false
      when: action in ['version', 'diagnose']

    - name: Read server image OCI version label
      ansible.builtin.command:
        cmd: docker inspect -f '{{"{{"}} index .Config.Labels "org.opencontainers.image.version" {{"}}"}}' {{ server_image_ref.stdout | default('woodpeckerci/woodpecker-server:latest') }}
      register: server_image_label_version
      changed_when: false
      failed_when: false
      when: action in ['version', 'diagnose']

    - name: Exec server --version inside container
      ansible.builtin.command:
        cmd: bash -lc "docker exec woodpecker-server sh -c 'woodpecker-server --version 2>/dev/null || /usr/local/bin/woodpecker-server --version 2>/dev/null || echo n/a'"
      register: server_bin_version
      changed_when: false
      failed_when: false
      when: action in ['version', 'diagnose']

    - name: Display Woodpecker version information
      ansible.builtin.debug:
        msg:
          - "Image (server): {{ server_image_ref.stdout | default('unknown') }}"
          - "OCI label version: {{ (server_image_label_version.stdout | trim) | default('unknown', true) }}"
          - "Binary --version: {{ (server_bin_version.stdout | trim) | default('unknown', true) }}"
          - "Compose images:"
          - "{{ images_output.stdout_lines | default([]) }}"
      when: action == 'version'

    - name: Check listening ports 8000/9000
      ansible.builtin.shell: |
        if command -v ss >/dev/null 2>&1; then
          ss -ltnp | grep -E ":8000|:9000" || true
        elif command -v netstat >/dev/null 2>&1; then
          netstat -tlnp | grep -E ":8000|:9000" || true
        else
          echo "Neither 'ss' nor 'netstat' is available"
        fi
      register: ports_output
      changed_when: false
      failed_when: false
      when: action == 'diagnose'

    - name: Display listening ports
      ansible.builtin.debug:
        var: ports_output.stdout_lines
      when:
        - action == 'diagnose'
        - ports_output is defined

    - name: Try local HTTP check on 8000
      ansible.builtin.command:
        cmd: bash -lc "curl -sS -o /dev/null -w '%{http_code}\n' http://127.0.0.1:8000/"
      register: http_check
      changed_when: false
      failed_when: false
      when: action == 'diagnose'

    - name: Display HTTP status code
      ansible.builtin.debug:
        msg: "Local HTTP status on 127.0.0.1:8000 => {{ http_check.stdout | default('n/a') }}"
      when: action == 'diagnose'

    - name: Display action result
      ansible.builtin.debug:
        msg:
          - "Action '{{ action }}' completed successfully"
          - "Woodpecker directory: {{ woodpecker_dir }}"
