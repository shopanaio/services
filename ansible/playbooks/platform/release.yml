# Release Platform service
# Bumps version, commits, tags, creates release branch and pushes
#
# Usage:
#   ansible-playbook playbooks/platform/release.yml
#   ansible-playbook playbooks/platform/release.yml -e "bump_type=minor"
#   ansible-playbook playbooks/platform/release.yml -e "bump_type=major"
#
# Bump types: patch (default), minor, major
---
- name: Release Platform service
  hosts: localhost
  connection: local
  become: false
  gather_facts: false

  vars:
    bump_type: patch
    platform_dir: "{{ playbook_dir }}/../../../platform"
    version_file: "{{ platform_dir }}/VERSION"

  tasks:
    - name: Check if VERSION file exists
      ansible.builtin.stat:
        path: "{{ version_file }}"
      register: version_file_stat

    - name: Create VERSION file if not exists
      ansible.builtin.copy:
        content: "0.0.0\n"
        dest: "{{ version_file }}"
        mode: "0644"
      when: not version_file_stat.stat.exists

    - name: Read current version
      ansible.builtin.slurp:
        src: "{{ version_file }}"
      register: version_content

    - name: Parse current version
      ansible.builtin.set_fact:
        current_version: "{{ (version_content.content | b64decode).strip() }}"

    - name: Parse version components
      ansible.builtin.set_fact:
        version_parts: "{{ current_version.split('.') }}"

    - name: Calculate new version
      ansible.builtin.set_fact:
        new_version: >-
          {%- if bump_type == 'major' -%}
            {{ (version_parts[0] | int) + 1 }}.0.0
          {%- elif bump_type == 'minor' -%}
            {{ version_parts[0] }}.{{ (version_parts[1] | int) + 1 }}.0
          {%- else -%}
            {{ version_parts[0] }}.{{ version_parts[1] }}.{{ (version_parts[2] | int) + 1 }}
          {%- endif -%}

    - name: Show version bump info
      ansible.builtin.debug:
        msg:
          - "Current version: {{ current_version }}"
          - "Bump type: {{ bump_type }}"
          - "New version: {{ new_version }}"

    - name: Update VERSION file
      ansible.builtin.copy:
        content: "{{ new_version }}\n"
        dest: "{{ version_file }}"
        mode: "0644"

    - name: Check for uncommitted changes
      ansible.builtin.command:
        cmd: git status --porcelain
        chdir: "{{ platform_dir }}"
      register: git_status
      changed_when: false

    - name: Commit version bump
      ansible.builtin.shell: |
        cd "{{ platform_dir }}"
        git add VERSION
        git commit -m "chore(release): v{{ new_version }}"
      when: git_status.stdout | length > 0
      changed_when: true

    - name: Create git tag
      ansible.builtin.command:
        cmd: git tag -a "v{{ new_version }}" -m "Release v{{ new_version }}"
        chdir: "{{ platform_dir }}"
      changed_when: true

    - name: Create release branch
      ansible.builtin.command:
        cmd: git checkout -b "release/v{{ new_version }}"
        chdir: "{{ platform_dir }}"
      changed_when: true

    - name: Push release branch
      ansible.builtin.command:
        cmd: git push -u origin "release/v{{ new_version }}"
        chdir: "{{ platform_dir }}"
      changed_when: true

    - name: Push tag
      ansible.builtin.command:
        cmd: git push origin "v{{ new_version }}"
        chdir: "{{ platform_dir }}"
      changed_when: true

    - name: Show success message
      ansible.builtin.debug:
        msg:
          - ""
          - "Release v{{ new_version }} created successfully!"
          - ""
          - "Created:"
          - "  - Commit: chore(release): v{{ new_version }}"
          - "  - Tag: v{{ new_version }}"
          - "  - Branch: release/v{{ new_version }}"
          - ""
          - "GitHub Actions will now build and push:"
          - "  - ghcr.io/{{ lookup('env', 'GITHUB_REPOSITORY_OWNER') | default('shopanaio', true) }}/platform:v{{ new_version }}"
          - ""
          - "To deploy after build completes:"
          - "  ansible-playbook playbooks/platform/deploy.yml -i hosts.ini --limit shopana_sandbox -e 'image_tag=v{{ new_version }}'"
          - ""
          - "To return to main branch:"
          - "  cd platform && git checkout main"
