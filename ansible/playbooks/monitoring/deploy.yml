# Deploy Monitoring Stack (Prometheus, Grafana, Loki, Promtail)
# Variables are loaded from vars file
# Usage: ansible-playbook playbooks/monitoring/deploy.yml -i hosts.ini --limit shopana_sandbox
---
- name: Deploy Monitoring Stack
  hosts: shopana_sandbox
  become: true

  vars_files:
    - sandbox.vars.yml

  vars:
    # Application configuration
    app_name: monitoring
    app_dir: /opt/shopana/monitoring

  tasks:
    - name: Ensure required variables are provided
      ansible.builtin.assert:
        that:
          - grafana_port is defined
          - prometheus_port is defined
          - loki_port is defined
          - promtail_port is defined
          - monitoring_network is defined
        fail_msg: "Please provide required variables via inventory or vars file."
      run_once: true
      delegate_to: localhost
      become: false

    - name: Create remote deployment directory
      ansible.builtin.file:
        path: "{{ app_dir }}"
        state: directory
        mode: "0755"

    - name: Create config directories
      ansible.builtin.file:
        path: "{{ app_dir }}/config/{{ item }}"
        state: directory
        mode: "0755"
      loop:
        - prometheus
        - loki
        - promtail
        - grafana/provisioning/datasources
        - grafana/provisioning/dashboards
        - grafana/provisioning/dashboards/json
        - grafana/provisioning/dashboards/service-json

    - name: Generate docker-compose.yml from template
      ansible.builtin.template:
        src: "{{ playbook_dir }}/docker-compose.yml.j2"
        dest: "{{ app_dir }}/docker-compose.yml"
        mode: "0644"

    - name: Generate Prometheus configuration
      ansible.builtin.template:
        src: "{{ playbook_dir }}/config/prometheus/prometheus.yml.j2"
        dest: "{{ app_dir }}/config/prometheus/prometheus.yml"
        mode: "0644"

    - name: Generate Loki configuration
      ansible.builtin.template:
        src: "{{ playbook_dir }}/config/loki/loki-config.yaml.j2"
        dest: "{{ app_dir }}/config/loki/loki-config.yaml"
        mode: "0644"

    - name: Generate Promtail configuration
      ansible.builtin.template:
        src: "{{ playbook_dir }}/config/promtail/promtail-config.yaml.j2"
        dest: "{{ app_dir }}/config/promtail/promtail-config.yaml"
        mode: "0644"

    - name: Generate Grafana datasources configuration
      ansible.builtin.template:
        src: "{{ playbook_dir }}/config/grafana/provisioning/datasources/datasources.yml.j2"
        dest: "{{ app_dir }}/config/grafana/provisioning/datasources/datasources.yml"
        mode: "0644"

    - name: Generate Grafana dashboards configuration
      ansible.builtin.template:
        src: "{{ playbook_dir }}/config/grafana/provisioning/dashboards/dashboards.yml.j2"
        dest: "{{ app_dir }}/config/grafana/provisioning/dashboards/dashboards.yml"
        mode: "0644"

    - name: Generate Grafana dashboard files
      ansible.builtin.template:
        src: "{{ playbook_dir }}/config/grafana/dashboards/{{ item }}.j2"
        dest: "{{ app_dir }}/config/grafana/provisioning/dashboards/json/{{ item }}"
        mode: "0644"
      loop:
        - container-logs.json
        - container-metrics.json
        - services-health.json
        - moleculer-services.json

    - name: Generate service-specific dashboards
      ansible.builtin.template:
        src: "{{ playbook_dir }}/config/grafana/dashboards/{{ item.name }}-service.json.j2"
        dest: "{{ app_dir }}/config/grafana/provisioning/dashboards/service-json/{{ item.name }}-service.json"
        mode: "0644"
      loop: "{{ service_dashboards }}"
      when: grafana_service_dashboards_enabled | default(true)

    - name: Generate service-specific log dashboards
      ansible.builtin.template:
        src: "{{ playbook_dir }}/config/grafana/dashboards/{{ item.name }}-service-logs.json.j2"
        dest: "{{ app_dir }}/config/grafana/provisioning/dashboards/json/{{ item.name }}-service-logs.json"
        mode: "0644"
      loop: "{{ service_dashboards }}"
      when: grafana_service_logs_dashboards_enabled | default(true)

    - name: Ensure Docker network exists
      community.docker.docker_network:
        name: "{{ monitoring_network }}"
        state: present

    - name: Deploy block
      block:
        - name: Show deployment information
          ansible.builtin.debug:
            msg:
              - "ðŸš€ Deploying {{ app_name }} stack"
              - "  Grafana Port: {{ grafana_port }}"
              - "  Prometheus Port: {{ prometheus_port }}"
              - "  Loki Port: {{ loki_port }}"
              - "  Promtail Port: {{ promtail_port }}"
              - "  Directory: {{ app_dir }}"

        - name: Cleanup containers on monitoring ports
          ansible.builtin.include_tasks: "{{ root_dir }}/ansible/tasks/cleanup-port-task.yml"
          vars:
            cleanup_port: "{{ item }}"
          loop:
            - "{{ grafana_port }}"
            - "{{ prometheus_port }}"
            - "{{ loki_port }}"
            - "{{ promtail_port }}"

        - name: Stop and remove existing monitoring containers if running
          ansible.builtin.command:
            cmd: docker compose down
            chdir: "{{ app_dir }}"
          ignore_errors: true
          changed_when: true

        - name: Wait for ports to be released
          ansible.builtin.wait_for:
            port: "{{ item }}"
            state: stopped
            timeout: 30
          ignore_errors: true
          loop:
            - "{{ grafana_port }}"
            - "{{ prometheus_port }}"
            - "{{ loki_port }}"
            - "{{ promtail_port }}"

        - name: Additional pause to ensure cleanup
          ansible.builtin.pause:
            seconds: 3

        - name: Start monitoring stack with Docker Compose
          community.docker.docker_compose_v2:
            project_src: "{{ app_dir }}"
            state: present

        - name: Wait for services to start
          ansible.builtin.pause:
            seconds: 10

        - name: Show startup logs
          ansible.builtin.command:
            cmd: docker compose logs --tail=30
            chdir: "{{ app_dir }}"
          register: startup_logs
          changed_when: false

        - name: Display startup logs
          ansible.builtin.debug:
            var: startup_logs.stdout_lines

        - name: Wait for Prometheus to be ready
          ansible.builtin.wait_for:
            host: 127.0.0.1
            port: "{{ prometheus_port }}"
            delay: 3
            timeout: 60

        - name: Wait for Loki to be ready
          ansible.builtin.wait_for:
            host: 127.0.0.1
            port: "{{ loki_port }}"
            delay: 3
            timeout: 60

        - name: Wait for Grafana to be ready
          ansible.builtin.wait_for:
            host: 127.0.0.1
            port: "{{ grafana_port }}"
            delay: 3
            timeout: 60

        - name: Show container status
          ansible.builtin.command:
            cmd: docker compose ps
            chdir: "{{ app_dir }}"
          register: compose_ps
          changed_when: false

        - name: Display status
          ansible.builtin.debug:
            var: compose_ps.stdout_lines

        - name: Show success message
          ansible.builtin.debug:
            msg:
              - "âœ… Monitoring stack deployed successfully"
              - ""
              - "ðŸŒ Service URLs:"
              - "  ðŸ“Š Grafana: http://{{ ansible_host }}:{{ grafana_port }}"
              - "     Username: {{ grafana_admin_user }}"
              - "     Password: {{ grafana_admin_password }}"
              - ""
              - "  ðŸ“ˆ Prometheus: http://{{ ansible_host }}:{{ prometheus_port }}"
              - "  ðŸ“‹ Loki: http://{{ ansible_host }}:{{ loki_port }}"
              - "  ðŸ” Promtail: http://{{ ansible_host }}:{{ promtail_port }}/targets"
              - ""
              - "ðŸ“‚ Directory: {{ app_dir }}"
              - ""
              - "ðŸ“Š View Logs:"
              - "  All services: ssh {{ ansible_host }} 'cd {{ app_dir }} && docker compose logs -f'"
              - "  Grafana: ssh {{ ansible_host }} 'cd {{ app_dir }} && docker compose logs -f grafana'"
              - "  Prometheus: ssh {{ ansible_host }} 'cd {{ app_dir }} && docker compose logs -f prometheus'"
              - "  Loki: ssh {{ ansible_host }} 'cd {{ app_dir }} && docker compose logs -f loki'"
              - "  Promtail: ssh {{ ansible_host }} 'cd {{ app_dir }} && docker compose logs -f promtail'"
              - ""
              - "ðŸ”§ Manage Services:"
              - "  Restart: ssh {{ ansible_host }} 'cd {{ app_dir }} && docker compose restart'"
              - "  Stop: ssh {{ ansible_host }} 'cd {{ app_dir }} && docker compose stop'"
              - "  Start: ssh {{ ansible_host }} 'cd {{ app_dir }} && docker compose start'"
              - ""
              - "ðŸ’¡ Quick Start in Grafana:"
              - "  1. Open Grafana at http://{{ ansible_host }}:{{ grafana_port }}"
              - "  2. Login with admin/{{ grafana_admin_password }}"
              - "  3. Go to 'Explore' -> Select 'Loki' datasource"
              - "  4. Use LogQL queries like: {container_name=~\".+\"}"
              - "  5. Filter by service: {compose_service=\"platform\"}"
              - ""
              - "ðŸ“š Useful LogQL queries:"
              - "  All logs: {container_name=~\".+\"}"
              - "  By service: {compose_service=\"orders\"}"
              - "  By project: {compose_project=\"shopana\"}"
              - "  Errors only: {container_name=~\".+\"} |= \"ERROR\""
              - "  Last 5m: {container_name=~\".+\"} [5m]"

      rescue:
        - name: Show error details
          ansible.builtin.debug:
            msg:
              - "âŒ Deployment failed!"
              - "Task: {{ ansible_failed_task.name | default('Unknown') }}"
              - "Error: {{ ansible_failed_result.msg | default('No message') }}"
              - "{% if ansible_failed_result.stderr is defined and ansible_failed_result.stderr | length > 0 %}Stderr: {{ ansible_failed_result.stderr }}{% endif %}"

        - name: Show container status on error
          ansible.builtin.command:
            cmd: docker compose ps
            chdir: "{{ app_dir }}"
          register: error_compose_ps
          changed_when: false
          ignore_errors: true

        - name: Display error container status
          ansible.builtin.debug:
            var: error_compose_ps.stdout_lines
          when: error_compose_ps is defined

        - name: Show container logs on error
          ansible.builtin.command:
            cmd: docker compose logs --tail=100
            chdir: "{{ app_dir }}"
          register: error_logs
          changed_when: false
          ignore_errors: true

        - name: Display error logs
          ansible.builtin.debug:
            var: error_logs.stdout_lines
          when: error_logs is defined and error_logs.stdout_lines is defined

        - name: Show recovery instructions
          ansible.builtin.debug:
            msg:
              - "ðŸ’¡ Recovery options:"
              - "  â€¢ Retry: ansible-playbook playbooks/monitoring/deploy.yml -i hosts.ini --limit shopana_sandbox"
              - "  â€¢ Check logs: ssh {{ ansible_host }} 'cd {{ app_dir }} && docker compose logs'"
              - "  â€¢ Check config: ssh {{ ansible_host }} 'ls -la {{ app_dir }}/config/'"

        - name: Fail with message
          ansible.builtin.fail:
            msg: "Deployment failed. See error details above."
