# Build admin Docker image
# Usage: ansible-playbook playbooks/admin/build.yml -i hosts.ini
---
- name: Build Admin Docker Image
  hosts: localhost
  connection: local
  become: false
  gather_facts: true

  vars_files:
    - "{{ playbook_dir }}/{{ vars_file | default('sandbox.vars.yml', true) }}"

  vars:
    # Build context
    admin_source_dir: "{{ root_dir }}/admin"

    # Image configuration
    admin_image_tag: "{{ image_tag | default('latest', true) }}"
    admin_image_name: "{{ shopana_ghcr_registry }}/{{ shopana_ghcr_owner }}/admin:{{ admin_image_tag }}"

  tasks:
    - name: Ensure required variables are provided
      ansible.builtin.assert:
        that:
          - shopana_ghcr_owner is defined and shopana_ghcr_owner | length > 0
          - shopana_ghcr_token is defined and shopana_ghcr_token | length > 0
        fail_msg: >-
          Please provide required variables via inventory or vars file.
          Required: shopana_ghcr_owner, shopana_ghcr_token, admin_api_url, admin_upload_url

    - name: Build admin image locally
      block:
        - name: Check if admin directory exists
          ansible.builtin.stat:
            path: "{{ admin_source_dir }}"
          register: admin_dir_stat

        - name: Fail if admin directory doesn't exist
          ansible.builtin.fail:
            msg: "Admin source directory not found: {{ admin_source_dir }}"
          when: not admin_dir_stat.stat.exists

        - name: Build Docker image
          ansible.builtin.command:
            cmd: >
              docker build
              --platform "{{ docker_platform }}"
              --build-arg CMSCLIENT_ENV={{ admin_env }}
              --build-arg CMSCLIENT_API_URL={{ admin_api_url }}
              --build-arg CMSCLIENT_UPLOAD_URL={{ admin_upload_url }}
              --tag {{ admin_image_name }}
              --pull
              {{ admin_source_dir }}
          changed_when: true

        - name: Login and push admin image
          ansible.builtin.shell: |
            echo "{{ shopana_ghcr_token }}" | docker login {{ shopana_ghcr_registry }} -u {{ shopana_ghcr_owner }} --password-stdin
            docker push {{ admin_image_name }}
          no_log: true
          changed_when: true

        - name: Show success message
          ansible.builtin.debug:
            msg:
              - "‚úÖ Admin image built and pushed successfully"
              - ""
              - "üì¶ Image Info:"
              - "  Name: {{ admin_image_name }}"
              - "  Environment: {{ admin_env }}"
              - "  API URL: {{ admin_api_url }}"
              - "  Upload URL: {{ admin_upload_url }}"
              - ""
              - "üöÄ Deploy:"
              - "  ansible-playbook playbooks/admin/deploy.yml -i hosts.ini --limit shopana_sandbox"

      rescue:
        - name: Show error details
          ansible.builtin.debug:
            msg:
              - "‚ùå Build failed!"
              - "Task: {{ ansible_failed_task.name | default('Unknown') }}"
              - "Error: {{ ansible_failed_result.msg | default('No message') }}"

        - name: Fail with message
          ansible.builtin.fail:
            msg: "Build failed. See error details above."

      always:
        - name: Logout from GitHub Container Registry
          ansible.builtin.command:
            cmd: "docker logout {{ shopana_ghcr_registry }}"
          changed_when: false
          ignore_errors: true
