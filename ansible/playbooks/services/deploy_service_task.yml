---
# Task file for deploying a single service
# This file is included by deploy_all.yml for each service
# Variables required: service_name, service_image_tag

- name: Set service-specific variables
  ansible.builtin.set_fact:
    app_dir: "/opt/shopana/services/{{ service_name }}"
    service_port: "{{ lookup('vars', service_name + '_port', default=10000) }}"
    service_database_url: "{{ lookup('vars', service_name + '_database_url', default=services_database_url) }}"
    service_image_name: "{{ shopana_ghcr_registry }}/{{ shopana_ghcr_owner }}/{{ service_name }}-service:{{ service_image_tag }}"

- name: Create remote deployment directory for {{ service_name }}
  ansible.builtin.file:
    path: "{{ app_dir }}"
    state: directory
    mode: "0755"

- name: Generate config.yml from template for {{ service_name }}
  ansible.builtin.template:
    src: "{{ playbook_dir }}/config.yml.j2"
    dest: "{{ app_dir }}/config.yml"
    mode: "0644"

- name: Generate docker-compose.yml from template for {{ service_name }}
  ansible.builtin.template:
    src: "{{ playbook_dir }}/docker-compose-service.yml.j2"
    dest: "{{ app_dir }}/docker-compose.yml"
    mode: "0644"

- name: Deploy {{ service_name }} service
  block:
    - name: Show deployment information for {{ service_name }}
      ansible.builtin.debug:
        msg:
          - "üöÄ Deploying {{ service_name }}-service"
          - "  Image: {{ service_image_name }}"
          - "  Port: {{ service_port }}"
          - "  Directory: {{ app_dir }}"

    - name: Login to GitHub Container Registry
      community.docker.docker_login:
        registry: "{{ shopana_ghcr_registry }}"
        username: "{{ shopana_ghcr_owner }}"
        password: "{{ shopana_ghcr_token }}"
      no_log: true

    - name: Cleanup containers on port {{ service_port }}
      ansible.builtin.include_tasks: "{{ root_dir }}/ansible/tasks/cleanup-port-task.yml"
      vars:
        cleanup_port: "{{ service_port }}"

    - name: Stop and remove existing {{ service_name }} container if running
      ansible.builtin.command:
        cmd: docker compose down
        chdir: "{{ app_dir }}"
      ignore_errors: true
      changed_when: true

    - name: Wait for port {{ service_port }} to be released
      ansible.builtin.wait_for:
        port: "{{ service_port }}"
        state: stopped
        timeout: 30
      ignore_errors: true

    - name: Additional pause to ensure cleanup
      ansible.builtin.pause:
        seconds: 2

    - name: Pull the latest image and start {{ service_name }} with Docker Compose
      community.docker.docker_compose_v2:
        project_src: "{{ app_dir }}"
        pull: always
        state: present

    - name: Wait a moment for {{ service_name }} container to start
      ansible.builtin.pause:
        seconds: 5

    - name: Check container status before waiting for port
      ansible.builtin.command:
        cmd: docker compose ps
        chdir: "{{ app_dir }}"
      register: compose_ps_before
      changed_when: false

    - name: Display container status before port check
      ansible.builtin.debug:
        msg:
          - "Container status:"
          - "{{ compose_ps_before.stdout }}"

    - name: Get container logs to check for errors
      ansible.builtin.command:
        cmd: docker compose logs --tail=50
        chdir: "{{ app_dir }}"
      register: compose_logs
      changed_when: false

    - name: Display container logs
      ansible.builtin.debug:
        msg:
          - "Container logs (last 50 lines):"
          - "{{ compose_logs.stdout }}"

    - name: Wait for {{ service_name }} to listen on port {{ service_port }}
      block:
        - name: Wait for port to be available
          ansible.builtin.wait_for:
            host: 127.0.0.1
            port: "{{ service_port }}"
            delay: 3
            timeout: 60
      rescue:
        - name: Get container status on failure
          ansible.builtin.command:
            cmd: docker compose ps
            chdir: "{{ app_dir }}"
          register: compose_ps_failed
          changed_when: false
          ignore_errors: true

        - name: Get full container logs on failure
          ansible.builtin.command:
            cmd: docker compose logs --tail=100
            chdir: "{{ app_dir }}"
          register: compose_logs_failed
          changed_when: false
          ignore_errors: true

        - name: Display diagnostic information
          ansible.builtin.debug:
            msg:
              - "‚ùå Failed to wait for {{ service_name }} on port {{ service_port }}"
              - ""
              - "Container status:"
              - "{{ compose_ps_failed.stdout }}"
              - ""
              - "Container logs (last 100 lines):"
              - "{{ compose_logs_failed.stdout }}"

        - name: Fail with error message
          ansible.builtin.fail:
            msg: "{{ service_name }}-service failed to start on port {{ service_port }}"

    - name: Show container status for {{ service_name }}
      ansible.builtin.command:
        cmd: docker compose ps
        chdir: "{{ app_dir }}"
      register: compose_ps
      changed_when: false

    - name: Display status for {{ service_name }}
      ansible.builtin.debug:
        var: compose_ps.stdout_lines

    - name: Show success message for {{ service_name }}
      ansible.builtin.debug:
        msg:
          - "‚úÖ {{ service_name }}-service deployed successfully"
          - "  HTTP: http://{{ ansible_host }}:{{ service_port }}"

  always:
    - name: Logout from GitHub Container Registry
      ansible.builtin.command:
        cmd: "docker logout {{ shopana_ghcr_registry }}"
      changed_when: false
      ignore_errors: true
