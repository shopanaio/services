# Deploy all services to remote host using hybrid architecture
#
# Architecture:
#   - Orchestrator (one container): apps, platform, payments, inventory, delivery
#   - Standalone containers: checkout, orders
#
# Prerequisites:
#   - Services must be built and pushed to GHCR
#   - Host configuration in hosts.ini
#
# Usage:
#   ansible-playbook playbooks/services/deploy_all.yml -i hosts.ini --limit shopana_sandbox
#   ansible-playbook playbooks/services/deploy_all.yml -i hosts.ini --limit shopana_sandbox -e "image_tag=v1.0.0"
---
- name: Deploy all services to remote host (hybrid architecture)
  hosts: shopana_sandbox
  become: true

  vars_files:
    - sandbox.vars.yml

  vars:
    # Image tag with fallback
    final_image_tag: "{{ image_tag | default('latest', true) }}"

    # Orchestrator image tag
    orchestrator_image_tag: "{{ final_image_tag }}"

    # Standalone services (checkout and orders)
    standalone_services:
      - checkout
      - orders

  tasks:
    - name: Show deployment information
      ansible.builtin.debug:
        msg:
          - "üöÄ Deploying ALL services to {{ ansible_host }} (Hybrid Architecture)"
          - ""
          - "  Orchestrator (one container):"
          - "    ‚Ä¢ apps, platform, payments, inventory, delivery"
          - "    ‚Ä¢ Image: orchestrator-service:{{ orchestrator_image_tag }}"
          - "    ‚Ä¢ Port: {{ orchestrator_port }}"
          - ""
          - "  Standalone services:"
          - "    ‚Ä¢ checkout ‚Üí checkout-service:{{ final_image_tag }} (port {{ checkout_port }})"
          - "    ‚Ä¢ orders ‚Üí orders-service:{{ final_image_tag }} (port {{ orders_port }})"
          - ""
          - "  Image tag: {{ final_image_tag }}"

    # ========================================================================
    # Deploy Orchestrator
    # ========================================================================
    - name: Deploy orchestrator service
      block:
        - name: Include orchestrator deployment task
          ansible.builtin.include_tasks: deploy_orchestrator_task.yml

      rescue:
        - name: Show orchestrator deployment error
          ansible.builtin.debug:
            msg:
              - "‚ùå Orchestrator deployment failed"
              - "Task: {{ ansible_failed_task.name | default('Unknown') }}"
              - "Error: {{ ansible_failed_result.msg | default('No message') }}"

        - name: Continue with standalone services anyway
          ansible.builtin.debug:
            msg: "Continuing with standalone services deployment..."

    # ========================================================================
    # Deploy Standalone Services
    # ========================================================================
    - name: Deploy standalone services sequentially
      ansible.builtin.include_tasks: deploy_service_task.yml
      vars:
        service_name: "{{ item }}"
        service_image_tag: "{{ final_image_tag }}"
      loop: "{{ standalone_services }}"
      ignore_errors: true

    # ========================================================================
    # Show Summary
    # ========================================================================
    - name: Show completion message
      ansible.builtin.debug:
        msg:
          - "‚úÖ All services deployment process completed"
          - ""
          - "üèóÔ∏è  Architecture:"
          - "  Orchestrator ‚Üí http://{{ ansible_host }}:{{ orchestrator_port }}"
          - "    ‚Ä¢ apps (GraphQL API)"
          - "    ‚Ä¢ platform"
          - "    ‚Ä¢ payments"
          - "    ‚Ä¢ inventory"
          - "    ‚Ä¢ delivery"
          - ""
          - "  Standalone:"
          - "    ‚Ä¢ checkout ‚Üí http://{{ ansible_host }}:{{ checkout_port }}"
          - "    ‚Ä¢ orders ‚Üí http://{{ ansible_host }}:{{ orders_port }}"
          - ""
          - "üîç Check status:"
          - "  ssh {{ ansible_host }} 'docker ps'"
          - ""
          - "üìä View logs:"
          - "  Orchestrator: ssh {{ ansible_host }} 'cd /opt/shopana/services/orchestrator && docker compose logs -f'"
          - "  Checkout: ssh {{ ansible_host }} 'cd /opt/shopana/services/checkout && docker compose logs -f'"
          - "  Orders: ssh {{ ansible_host }} 'cd /opt/shopana/services/orders && docker compose logs -f'"
