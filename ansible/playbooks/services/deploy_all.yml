# Deploy all services to remote host
#
# Architecture:
#   - Orchestrator (one container): all services (apps, checkout, orders, payments, inventory, delivery, pricing)
#
# Prerequisites:
#   - Services must be built and pushed to GHCR
#   - Host configuration in hosts.ini
#
# Usage:
#   ansible-playbook playbooks/services/deploy_all.yml -i hosts.ini --limit shopana_sandbox
#   ansible-playbook playbooks/services/deploy_all.yml -i hosts.ini --limit shopana_sandbox -e "image_tag=v1.0.0"
---
- name: Deploy all services to remote host
  hosts: shopana_sandbox
  become: true

  vars_files:
    - sandbox.vars.yml

  vars:
    # Image tag with fallback
    final_image_tag: "{{ image_tag | default('latest', true) }}"

    # Orchestrator image tag
    orchestrator_image_tag: "{{ final_image_tag }}"

  tasks:
    - name: Show deployment information
      ansible.builtin.debug:
        msg:
          - "üöÄ Deploying ALL services to {{ ansible_host }}"
          - ""
          - "  Orchestrator (one container):"
          - "    ‚Ä¢ apps, checkout, orders, delivery, inventory, payments, pricing"
          - "    ‚Ä¢ Image: orchestrator-service:{{ orchestrator_image_tag }}"
          - "    ‚Ä¢ Metrics port: {{ orchestrator_metrics_port | default(3030) }}"
          - ""
          - "  Image tag: {{ final_image_tag }}"

    # ========================================================================
    # Deploy Orchestrator
    # ========================================================================
    - name: Deploy orchestrator service
      block:
        - name: Include orchestrator deployment task
          ansible.builtin.include_tasks: deploy_orchestrator_task.yml

      rescue:
        - name: Show orchestrator deployment error
          ansible.builtin.debug:
            msg:
              - "‚ùå Orchestrator deployment failed"
              - "Task: {{ ansible_failed_task.name | default('Unknown') }}"
              - "Error: {{ ansible_failed_result.msg | default('No message') }}"

        - name: Fail deployment
          ansible.builtin.fail:
            msg: "Orchestrator deployment failed. See error details above."

    # ========================================================================
    # Show Summary
    # ========================================================================
    - name: Show completion message
      ansible.builtin.debug:
        msg:
          - "‚úÖ All services deployment process completed"
          - ""
          - "üèóÔ∏è  Architecture:"
          - "  Orchestrator (one container - configured via config.yml):"
          - "    ‚Ä¢ Services: apps, checkout, orders, delivery, inventory, payments, pricing"
          - "    ‚Ä¢ Apps GraphQL API ‚Üí http://{{ ansible_host }}:{{ apps_port }}"
          - "    ‚Ä¢ Metrics/Health ‚Üí http://{{ ansible_host }}:{{ orchestrator_metrics_port | default(3030) }}"
          - ""
          - "üîç Check status:"
          - "  ssh {{ ansible_host }} 'docker ps'"
          - ""
          - "üìä View logs:"
          - "  Orchestrator: ssh {{ ansible_host }} 'cd /opt/shopana/services/orchestrator && docker compose logs -f'"
