# Reusable task for deploying orchestrator service
# This task is included by deploy_orchestrator.yml and deploy_all.yml
#
# Required variables:
#   - orchestrator_metrics_port
#   - orchestrator_image_tag
#   - apps_port

---
- name: Set orchestrator directory
  ansible.builtin.set_fact:
    orchestrator_dir: "/opt/shopana/services/orchestrator"

- name: Show deployment information
  ansible.builtin.debug:
    msg:
      - "üöÄ Deploying orchestrator-service"
      - "  Image: {{ shopana_ghcr_registry }}/{{ shopana_ghcr_owner }}/orchestrator-service:{{ orchestrator_image_tag }}"
      - "  Metrics Port: {{ orchestrator_metrics_port }}"
      - "  Directory: {{ orchestrator_dir }}"
      - "  Services: apps, payments, inventory, delivery, pricing"

- name: Create orchestrator deployment directory
  ansible.builtin.file:
    path: "{{ orchestrator_dir }}"
    state: directory
    mode: "0755"

- name: Generate config.yml from template
  ansible.builtin.template:
    src: "{{ playbook_dir }}/config.yml.j2"
    dest: "{{ orchestrator_dir }}/config.yml"
    mode: "0644"

- name: Generate docker-compose.yml from template
  ansible.builtin.template:
    src: "{{ playbook_dir }}/docker-compose-orchestrator.yml.j2"
    dest: "{{ orchestrator_dir }}/docker-compose.yml"
    mode: "0644"

- name: Login to GitHub Container Registry on the remote server
  community.docker.docker_login:
    registry: "{{ shopana_ghcr_registry }}"
    username: "{{ shopana_ghcr_owner }}"
    password: "{{ shopana_ghcr_token }}"
  no_log: true

- name: Cleanup containers on metrics port {{ orchestrator_metrics_port }}
  ansible.builtin.include_tasks: "{{ root_dir }}/ansible/tasks/cleanup-port-task.yml"
  vars:
    cleanup_port: "{{ orchestrator_metrics_port }}"

- name: Stop and remove existing orchestrator container if running
  ansible.builtin.command:
    cmd: docker compose down
    chdir: "{{ orchestrator_dir }}"
  ignore_errors: true
  changed_when: true

- name: Wait for metrics port to be released
  ansible.builtin.wait_for:
    port: "{{ orchestrator_metrics_port }}"
    state: stopped
    timeout: 30
  ignore_errors: true

- name: Additional pause to ensure cleanup
  ansible.builtin.pause:
    seconds: 2

- name: Pull the latest image and start orchestrator with Docker Compose
  community.docker.docker_compose_v2:
    project_src: "{{ orchestrator_dir }}"
    pull: always
    state: present

- name: Wait a moment for container to start
  ansible.builtin.pause:
    seconds: 5

- name: Show startup logs
  ansible.builtin.command:
    cmd: docker compose logs --tail=50
    chdir: "{{ orchestrator_dir }}"
  register: startup_logs
  changed_when: false

- name: Display startup logs
  ansible.builtin.debug:
    var: startup_logs.stdout_lines

- name: Wait for orchestrator metrics endpoint to be ready
  ansible.builtin.wait_for:
    host: 127.0.0.1
    port: "{{ orchestrator_metrics_port }}"
    delay: 3
    timeout: 60

- name: Show container status
  ansible.builtin.command:
    cmd: docker compose ps
    chdir: "{{ orchestrator_dir }}"
  register: compose_ps
  changed_when: false

- name: Display status
  ansible.builtin.debug:
    var: compose_ps.stdout_lines

- name: Show success message
  ansible.builtin.debug:
    msg:
      - "‚úÖ orchestrator-service deployed successfully"
      - ""
      - "üåê Service Info:"
      - "  Image: {{ shopana_ghcr_registry }}/{{ shopana_ghcr_owner }}/orchestrator-service:{{ orchestrator_image_tag }}"
      - "  Directory: {{ orchestrator_dir }}"
      - ""
      - "üì¶ Services in orchestrator (configured via config.yml):"
      - "  ‚Ä¢ apps, delivery, inventory, payments, pricing"
      - ""
      - "üåê Exposed endpoints:"
      - "  ‚Ä¢ Apps GraphQL API: http://{{ ansible_host }}:{{ apps_port }}"
      - "  ‚Ä¢ Health: http://{{ ansible_host }}:{{ orchestrator_metrics_port }}/health"
      - "  ‚Ä¢ Metrics: http://{{ ansible_host }}:{{ orchestrator_metrics_port }}/metrics"
      - ""
      - "üìä View Logs:"
      - "  ssh {{ ansible_host }} 'cd {{ orchestrator_dir }} && docker compose logs -f'"
      - ""
      - "üîß Manage Service:"
      - "  ssh {{ ansible_host }} 'cd {{ orchestrator_dir }} && docker compose restart'"
      - "  ssh {{ ansible_host }} 'cd {{ orchestrator_dir }} && docker compose stop'"

- name: Logout from GitHub Container Registry on the remote server
  ansible.builtin.command:
    cmd: "docker logout {{ shopana_ghcr_registry }}"
  changed_when: false
  ignore_errors: true
