# Build and push single service image
# Automatically builds base image with packages first
#
# Prerequisites:
#   - Docker must be running locally
#   - SHOPANA_GHCR_OWNER and SHOPANA_GITHUB_TOKEN environment variables
#
# Usage:
#   ansible-playbook playbooks/services/build_single.yml -e "service_name=checkout" -e "image_tag=v1.0.0"
#   ansible-playbook playbooks/services/build_single.yml -e "service_name=checkout" -e "skip_base_build=true"
---
- name: Build and push single service
  hosts: localhost
  connection: local
  become: false
  gather_facts: true

  vars:
    # Build configuration
    local_build_dir: "{{ root_dir }}"
    dockerfile_path: "{{ root_dir }}/Dockerfile"
    dockerfile_base_path: "{{ root_dir }}/Dockerfile.base"

    # Service configuration (must be provided via -e flag)
    # service_name: checkout  # Example
    # image_tag: latest       # Optional, defaults to 'latest'

    # Image tag with fallback
    final_image_tag: "{{ image_tag | default('latest', true) }}"

    # Skip base build flag (set to true to skip if packages unchanged)
    skip_base_build_flag: "{{ skip_base_build | default(false, true) }}"

    # Valid service names
    valid_services:
      - apps
      - checkout
      - delivery
      - inventory
      - orders
      - payments
      - platform
      - pricing

  tasks:
    - name: Validate service_name is provided
      ansible.builtin.assert:
        that:
          - service_name is defined
          - service_name | length > 0
        fail_msg: >-
          service_name is required. Usage:
          ansible-playbook playbooks/services/build_single.yml -e "service_name=checkout"
        success_msg: "Service name provided: {{ service_name }}"

    - name: Validate service_name is in valid list
      ansible.builtin.assert:
        that:
          - service_name in valid_services
        fail_msg: >-
          Invalid service name: {{ service_name }}.
          Valid services: {{ valid_services | join(', ') }}
        success_msg: "Service name is valid"

    - name: Validate required variables are provided
      ansible.builtin.assert:
        that:
          - shopana_ghcr_owner is defined and shopana_ghcr_owner | length > 0
          - shopana_ghcr_token is defined and shopana_ghcr_token | length > 0
        fail_msg: >-
          Required variables missing. Provide SHOPANA_GHCR_OWNER and SHOPANA_GITHUB_TOKEN
          via environment or -e "VAR=...".
          Example: export SHOPANA_GHCR_OWNER=shopanaio SHOPANA_GITHUB_TOKEN=ghp_xxx
        success_msg: "All required variables are present"

    - name: Check if Docker is running
      ansible.builtin.command:
        cmd: docker info
      register: docker_info
      changed_when: false
      failed_when: false

    - name: Fail if Docker is not running
      ansible.builtin.fail:
        msg: "Docker is not running locally. Please start Docker daemon."
      when: docker_info.rc != 0

    # ========================================================================
    # Build service
    # ========================================================================
    - name: Build and push block with error handling
      block:
        - name: Show service build information
          ansible.builtin.debug:
            msg:
              - ""
              - "ðŸ”¨ Building {{ service_name }}-service"
              - "  Image: {{ shopana_ghcr_registry }}/{{ shopana_ghcr_owner }}/{{ service_name }}-service:{{ final_image_tag }}"
              - "  Dockerfile: {{ dockerfile_path }}"
              - "ðŸ” Registry: {{ shopana_ghcr_registry }}/{{ shopana_ghcr_owner }}"

        - name: Build service image
          ansible.builtin.command:
            cmd: >
              docker build
              --platform {{ docker_platform }}
              --build-arg SERVICE_NAME={{ service_name }}
              --build-arg BASE_IMAGE={{ shopana_ghcr_registry }}/{{ shopana_ghcr_owner }}/services-base:{{ final_image_tag }}
              --build-arg VERSION={{ final_image_tag }}
              --build-arg BUILD_DATE={{ ansible_date_time.iso8601 }}
              --build-arg VCS_REF={{ lookup('env', 'GIT_COMMIT') | default('unknown', true) }}
              -t {{ shopana_ghcr_registry }}/{{ shopana_ghcr_owner }}/{{ service_name }}-service:{{ final_image_tag }}
              -f {{ dockerfile_path }}
              .
            chdir: "{{ local_build_dir }}"
          changed_when: true

        - name: Push service image
          ansible.builtin.shell: |
              echo "{{ shopana_ghcr_token }}" | docker login {{ shopana_ghcr_registry }} -u {{ shopana_ghcr_owner }} --password-stdin
              docker push {{ shopana_ghcr_registry }}/{{ shopana_ghcr_owner }}/{{ service_name }}-service:{{ final_image_tag }}
          no_log: true
          changed_when: true

        - name: Show success message
          ansible.builtin.debug:
            msg:
              - ""
              - "âœ… Service image built and pushed successfully"
              - ""
              - "ðŸ“¦ Base image:"
              - "  â€¢ services-base:{{ final_image_tag }}"
              - ""
              - "ðŸ“¦ Service image:"
              - "  â€¢ {{ service_name }}-service:{{ final_image_tag }}"
              - ""
              - "ðŸš€ To build another service:"
              - "  ansible-playbook playbooks/services/build_single.yml -e 'service_name=orders' -e 'image_tag={{ final_image_tag }}'"
              - ""
              - "ðŸ’¡ Tip: If packages unchanged, skip base build next time:"
              - "  ansible-playbook playbooks/services/build_single.yml -e 'service_name={{ service_name }}' -e 'skip_base_build=true'"

      rescue:
        - name: Show error details
          ansible.builtin.debug:
            msg:
              - "âŒ Build or push failed!"
              - "Task: {{ ansible_failed_task.name | default('Unknown') }}"
              - "Error: {{ ansible_failed_result.msg | default('No message') }}"
              - "{% if ansible_failed_result.stderr is defined and ansible_failed_result.stderr | length > 0 %}Stderr: {{ ansible_failed_result.stderr }}{% endif %}"
              - ""
              - "ðŸ’¡ Common solutions:"
              - "  â€¢ Ensure service builds locally: cd services/{{ service_name }} && yarn build"
              - "  â€¢ Check SHOPANA_GITHUB_TOKEN has packages:write permission"
              - "  â€¢ Verify SHOPANA_GHCR_OWNER is correct: {{ shopana_ghcr_owner }}"
              - "  â€¢ Ensure Docker daemon is running"

        - name: Fail with message
          ansible.builtin.fail:
            msg: "Build and push failed. See error details above."

      always:
        - name: Logout from GitHub Container Registry
          ansible.builtin.command:
            cmd: docker logout {{ shopana_ghcr_registry }}
          changed_when: false
          ignore_errors: true
