---
# Task for building and pushing a single service
# This file is included by build_all.yml for each service

- name: "Show build info for {{ service.name }}"
  ansible.builtin.debug:
    msg:
      - "ðŸ”¨ Building {{ service.name }}-service"
      - "  Tag: {{ service.image_tag }}"

- name: "Build {{ service.name }}-service"
  ansible.builtin.command:
    cmd: >
      docker build
      --platform {{ docker_platform }}
      --build-arg SERVICE_NAME={{ service.name }}
      --build-arg BASE_IMAGE={{ shopana_ghcr_registry }}/{{ shopana_ghcr_owner }}/services-base:{{ service.image_tag }}
      --build-arg VERSION={{ service.image_tag }}
      --build-arg BUILD_DATE={{ ansible_date_time.iso8601 }}
      --build-arg VCS_REF={{ lookup('env', 'GIT_COMMIT') | default('unknown', true) }}
      -t {{ shopana_ghcr_registry }}/{{ shopana_ghcr_owner }}/{{ service.name }}-service:{{ service.image_tag }}
      -f {{ dockerfile_path }}
      .
    chdir: "{{ local_build_dir }}"
  changed_when: true
  register: build_result

- name: "Push {{ service.name }}-service"
  ansible.builtin.command:
    cmd: docker push {{ shopana_ghcr_registry }}/{{ shopana_ghcr_owner }}/{{ service.name }}-service:{{ service.image_tag }}
  changed_when: true

- name: "Show build result for {{ service.name }}"
  ansible.builtin.debug:
    msg:
      - "âœ… {{ service.name }}-service built and pushed successfully"
      - "ðŸ“¦ Image: {{ shopana_ghcr_registry }}/{{ shopana_ghcr_owner }}/{{ service.name }}-service:{{ service.image_tag }}"
