# NATS Server Configuration - Production
# Documentation: https://docs.nats.io/running-a-nats-service/configuration

# Server name (useful in cluster mode)
server_name: $SERVER_NAME

# Network settings
port: 4222
http_port: 8222

# Client connection settings
max_connections: 64000
max_control_line: 4096
max_payload: 10485760  # 10MB

# Ping interval
ping_interval: "2m"
ping_max: 2

# Write deadline
write_deadline: "10s"

# Max pending size for outbound messages
max_pending_size: 67108864  # 64MB

# TLS Configuration (optional, uncomment for production)
# tls {
#   cert_file: "/etc/nats/certs/server-cert.pem"
#   key_file: "/etc/nats/certs/server-key.pem"
#   ca_file: "/etc/nats/certs/ca.pem"
#   verify: true
# }

# Authentication (basic auth, for production use JWT/NKey)
authorization {
  # Default permissions for all users
  default_permissions {
    publish = {
      allow = ["app.v1.>", "moleculer.>", "shopana.>"]
    }
    subscribe = {
      allow = ["app.v1.>", "moleculer.>", "shopana.>", "_INBOX.>"]
    }
  }

  # Users (for development, use environment variables in production)
  users = [
    {
      user: $NATS_USER
      password: $NATS_PASSWORD
    }
  ]

  # Token authentication (alternative)
  # token: $NATS_TOKEN
}

# JetStream configuration
jetstream {
  # Storage directory
  store_dir: "/data/jetstream"

  # Maximum memory and storage for JetStream
  max_memory_store: 1GB
  max_file_store: 10GB

  # Sync interval for file store
  sync_interval: "2m"

  # Domain (optional, for multi-tenant)
  # domain: "shopana"
}

# System account for monitoring and management
system_account: $SYS

# Accounts (для изоляции между окружениями)
accounts {
  # System account
  $SYS {
    users = [
      { user: admin, password: $NATS_ADMIN_PASSWORD }
    ]
  }

  # Application account
  APP {
    jetstream: enabled
    users = [
      { user: $NATS_USER, password: $NATS_PASSWORD }
    ]
  }
}

# Logging
debug: false
trace: false
logtime: true
log_file: "/var/log/nats/nats-server.log"
log_size_limit: 100MB
max_traced_msg_len: 1024

# Monitoring
http: 8222

# Monitoring endpoints:
# - http://localhost:8222/varz       - General server stats
# - http://localhost:8222/connz      - Connection details
# - http://localhost:8222/routez     - Route details
# - http://localhost:8222/subsz      - Subscription details
# - http://localhost:8222/jsz        - JetStream stats
# - http://localhost:8222/healthz    - Health check

# Profiling (disable in production)
# prof_port: 6060

# Clustering (для high availability, раскомментировать при необходимости)
# cluster {
#   name: shopana_cluster
#   listen: 0.0.0.0:6222
#
#   # Routes to other servers
#   routes = [
#     nats://nats-1:6222
#     nats://nats-2:6222
#     nats://nats-3:6222
#   ]
#
#   # Cluster authentication
#   authorization {
#     user: $CLUSTER_USER
#     password: $CLUSTER_PASSWORD
#     timeout: 2
#   }
# }

# Leafnode connections (для hybrid cloud setup)
# leafnodes {
#   listen: 0.0.0.0:7422
#   authorization {
#     user: $LEAFNODE_USER
#     password: $LEAFNODE_PASSWORD
#   }
# }

# Gateway connections (для multi-region)
# gateway {
#   name: "region-eu"
#   listen: "0.0.0.0:7522"
#
#   gateways: [
#     {
#       name: "region-us"
#       urls: ["nats://nats-us.example.com:7522"]
#     }
#   ]
# }

# Limits
limits {
  # Maximum subscriptions per connection
  max_subscriptions: 1000

  # Maximum number of accounts
  max_accounts: 10

  # Maximum number of control line
  max_control_line: 4096
}
