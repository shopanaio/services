# Build and push platform image to GitHub Container Registry
# Usage: ansible-playbook playbooks/platform/build.yml
---
- name: Build and push platform image to GitHub Container Registry
  hosts: localhost
  connection: local
  become: false
  gather_facts: true

  vars:
    # Platform configuration
    platform_app_name: platform
    platform_image_tag: "{{ image_tag | default('latest', true) }}"
    platform_image_name: "{{ shopana_ghcr_registry }}/{{ shopana_ghcr_owner }}/{{ platform_app_name }}:{{ platform_image_tag }}"
    platform_build_context: "{{ root_dir }}/platform"

    # Build configuration
    platform_arch: linux/amd64
    local_build_dir: "{{ root_dir }}"

  tasks:
    - name: Validate required variables are provided
      ansible.builtin.assert:
        that:
          - shopana_ghcr_owner is defined and shopana_ghcr_owner | length > 0
          - shopana_ghcr_token is defined and shopana_ghcr_token | length > 0
        fail_msg: >-
          Required variables missing. Provide shopana_ghcr_owner and shopana_ghcr_token via inventory variables.
        success_msg: "All required variables are present"

    - name: Check if Docker is running
      ansible.builtin.command:
        cmd: docker info
      register: docker_info
      changed_when: false
      failed_when: false

    - name: Fail if Docker is not running
      ansible.builtin.fail:
        msg: "Docker is not running locally. Please start Docker daemon."
      when: docker_info.rc != 0

    - name: Build and push block with error handling
      block:
        - name: Show build information
          ansible.builtin.debug:
            msg:
              - "ðŸ”¨ Building {{ platform_app_name }}"
              - "  Image: {{ platform_image_name }}"
              - "  Platform: {{ platform_arch }}"
              - "  Build Context: {{ platform_build_context }}"
              - "ðŸ” Registry: {{ shopana_ghcr_registry }}/{{ shopana_ghcr_owner }}"

        - name: Login to GitHub Container Registry
          ansible.builtin.command:
            cmd: echo "{{ shopana_ghcr_token }}" | docker login {{ shopana_ghcr_registry }} -u {{ shopana_ghcr_owner }} --password-stdin
          no_log: true
          changed_when: true

        - name: Build platform image
          ansible.builtin.command:
            cmd: >
              docker build
              --platform {{ platform_arch }}
              --build-arg VERSION={{ platform_image_tag }}
              --build-arg BUILD_DATE={{ ansible_date_time.iso8601 }}
              -t {{ platform_image_name }}
              {{ platform_build_context }}
            chdir: "{{ local_build_dir }}"
          changed_when: true

        - name: Login and push platform image
          ansible.builtin.shell: |
            echo "{{ shopana_ghcr_token }}" | docker login {{ shopana_ghcr_registry }} -u {{ shopana_ghcr_owner }} --password-stdin
            docker push {{ platform_image_name }}
          no_log: true
          changed_when: true

        - name: Show success message
          ansible.builtin.debug:
            msg:
              - "âœ… Platform image built and pushed successfully"
              - "ðŸ“¦ Image: {{ platform_image_name }}"
              - ""
              - "ðŸš€ To deploy:"
              - "  ansible-playbook playbooks/platform/deploy.yml -i hosts.ini"

      rescue:
        - name: Show error details
          ansible.builtin.debug:
            msg:
              - "âŒ Build or push failed!"
              - "Task: {{ ansible_failed_task.name | default('Unknown') }}"
              - "Error: {{ ansible_failed_result.msg | default('No message') }}"
              - "{% if ansible_failed_result.stderr is defined and ansible_failed_result.stderr | length > 0 %}Stderr: {{ ansible_failed_result.stderr }}{% endif %}"
              - ""
              - "ðŸ’¡ Common solutions:"
              - "  â€¢ Ensure Go builds work: cd platform && go build ./project/cmd/main"
              - "  â€¢ Check shopana_ghcr_token has packages:write permission"
              - "  â€¢ Verify shopana_ghcr_owner is correct"
              - "  â€¢ Ensure Docker daemon is running"

        - name: Fail with message
          ansible.builtin.fail:
            msg: "Build and push failed. See error details above."

      always:
        - name: Logout from GitHub Container Registry
          ansible.builtin.command:
            cmd: docker logout {{ shopana_ghcr_registry }}
          changed_when: false
          ignore_errors: true
