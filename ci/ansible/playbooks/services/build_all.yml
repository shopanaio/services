# Build and push all services
# Automatically builds base image with packages first
#
# Prerequisites:
#   - Docker must be running locally
#   - SHOPANA_GHCR_OWNER and SHOPANA_GITHUB_TOKEN environment variables
#
# Usage:
#   ansible-playbook playbooks/services/build_all.yml
#   ansible-playbook playbooks/services/build_all.yml -e "image_tag=v1.0.0"
#   ansible-playbook playbooks/services/build_all.yml -e "skip_base_build=true"  # Skip base build if unchanged
---
- name: Build and push all services
  hosts: localhost
  connection: local
  become: false
  gather_facts: true

  vars:
    # Build configuration
    local_build_dir: "{{ root_dir }}"
    dockerfile_path: "{{ root_dir }}/ci/images/services/Dockerfile"
    dockerfile_base_path: "{{ root_dir }}/ci/images/services/Dockerfile.base"

    # Image tag with fallback
    final_image_tag: "{{ image_tag | default('latest', true) }}"

    # Skip base build flag (set to true to skip if packages unchanged)
    skip_base_build_flag: "{{ skip_base_build | default(false, true) }}"

    # All available services
    all_services:
      - apps
      - checkout
      - delivery
      - inventory
      - orders
      - payments
      - platform
      - pricing

  tasks:
    - name: Validate required variables are provided
      ansible.builtin.assert:
        that:
          - shopana_ghcr_owner is defined and shopana_ghcr_owner | length > 0
          - shopana_ghcr_token is defined and shopana_ghcr_token | length > 0
        fail_msg: >-
          Required variables missing. Provide SHOPANA_GHCR_OWNER and SHOPANA_GITHUB_TOKEN
          via environment or .env file.
        success_msg: "All required variables are present"

    - name: Check if Docker is running
      ansible.builtin.command:
        cmd: docker info
      register: docker_info
      changed_when: false
      failed_when: false

    - name: Fail if Docker is not running
      ansible.builtin.fail:
        msg: "Docker is not running locally. Please start Docker daemon."
      when: docker_info.rc != 0

    - name: Login to GitHub Container Registry
      ansible.builtin.shell: |
        echo "{{ shopana_ghcr_token }}" | docker login {{ shopana_ghcr_registry }} -u {{ shopana_ghcr_owner }} --password-stdin
      no_log: true
      changed_when: false

    # ========================================================================
    # Build base image with all shared packages first
    # ========================================================================
    - name: Show base image build information
      ansible.builtin.debug:
        msg:
          - "üì¶ Building base image with shared packages first"
          - "  Image: {{ shopana_ghcr_registry }}/{{ shopana_ghcr_owner }}/services-base:{{ final_image_tag }}"
          - "  Skip: {{ skip_base_build_flag }}"
      when: not skip_base_build_flag | bool

    - name: Build base image
      ansible.builtin.command:
        cmd: >
          docker build
          --platform {{ docker_platform }}
          --build-arg NODE_VERSION=20
          --build-arg VERSION={{ final_image_tag }}
          --build-arg BUILD_DATE={{ ansible_date_time.iso8601 }}
          --build-arg VCS_REF={{ lookup('env', 'GIT_COMMIT') | default('unknown', true) }}
          -t {{ shopana_ghcr_registry }}/{{ shopana_ghcr_owner }}/services-base:{{ final_image_tag }}
          -t {{ shopana_ghcr_registry }}/{{ shopana_ghcr_owner }}/services-base:latest
          -f {{ dockerfile_base_path }}
          .
        chdir: "{{ local_build_dir }}"
      changed_when: true
      when: not skip_base_build_flag | bool

    - name: Show base image success
      ansible.builtin.debug:
        msg:
          - "‚úÖ Base image built successfully"
          - "üì¶ {{ shopana_ghcr_registry }}/{{ shopana_ghcr_owner }}/services-base:{{ final_image_tag }}"
      when: not skip_base_build_flag | bool

    - name: Skipping base image build
      ansible.builtin.debug:
        msg:
          - "‚è≠Ô∏è  Skipping base image build (skip_base_build=true)"
          - "   Using existing: {{ shopana_ghcr_registry }}/{{ shopana_ghcr_owner }}/services-base:{{ final_image_tag }}"
      when: skip_base_build_flag | bool

    # ========================================================================
    # Build all services
    # ========================================================================
    - name: Show services build information
      ansible.builtin.debug:
        msg:
          - ""
          - "üî® Building ALL services"
          - "  Services: {{ all_services | join(', ') }}"
          - "  Image tag: {{ final_image_tag }}"
          - "  Total: {{ all_services | length }} services"

    - name: Build each service
      ansible.builtin.include_tasks: build_service_task.yml
      loop: "{{ all_services }}"
      vars:
        service:
          name: "{{ item }}"
          image_tag: "{{ final_image_tag }}"

    - name: Show completion message
      ansible.builtin.debug:
        msg:
          - ""
          - "‚úÖ All services built successfully"
          - ""
          - "üì¶ Base image:"
          - "  ‚Ä¢ services-base:{{ final_image_tag }}"
          - ""
          - "üì¶ Built services:"
          - "{% for service in all_services %}  ‚Ä¢ {{ service }}-service:{{ final_image_tag }}{% endfor %}"
          - ""
          - "üöÄ Next steps:"
          - "  Deploy single: ansible-playbook playbooks/services/deploy_single.yml -i hosts.ini -e 'service_name=checkout'"
          - "  Deploy all:    ansible-playbook playbooks/services/deploy_all.yml -i hosts.ini --limit shopana_sandbox"
          - ""
          - "üí° Tip: If packages unchanged, skip base build next time:"
          - "  ansible-playbook playbooks/services/build_all.yml -e 'skip_base_build=true'"

  post_tasks:
    - name: Logout from GitHub Container Registry
      ansible.builtin.command:
        cmd: docker logout {{ shopana_ghcr_registry }}
      changed_when: false
      ignore_errors: true
