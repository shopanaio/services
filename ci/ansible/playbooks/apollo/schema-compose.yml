# Compose Apollo supergraph schemas
# ansible-playbook playbooks/apollo/schema-compose.yml
---
- name: Compose Apollo supergraph schemas
  hosts: localhost
  connection: local
  become: false
  gather_facts: false

  vars_files:
    - vars.local.yml

  vars:
    # Path to the rover image we built (use 'local' tag for local development)
    rover_image_name: "shopana/apollo-rover:local"

    # Paths
    config_dir: "{{ playbook_dir }}/config"
    schema_dir: "{{ playbook_dir }}/schema"
    runtime_dir: "{{ playbook_dir }}/runtime"
    output_dir: "{{ runtime_dir }}/config"

  tasks:
    - name: Compose block with error handling
      block:
        - name: Check if Rover image exists
          ansible.builtin.command:
            cmd: docker image inspect {{ rover_image_name }}
          register: rover_check
          ignore_errors: true
          changed_when: false

        - name: Fail if rover image is not found
          ansible.builtin.fail:
            msg: >
              Docker image '{{ rover_image_name }}' not found.
              Please build it first by running:
              ansible-playbook playbooks/apollo/build.yml
          when: rover_check.rc != 0

        - name: Ensure output directory exists
          ansible.builtin.file:
            path: "{{ output_dir }}"
            state: directory
            mode: "0755"

        - name: Copy schema files to output directory
          ansible.builtin.copy:
            src: "{{ schema_dir }}/"
            dest: "{{ output_dir }}/schema/"
            mode: "0644"

        - name: Compose supergraph schemas
          ansible.builtin.include_tasks: tasks/schema-compose.yml

        - name: Show success message
          ansible.builtin.debug:
            msg:
              - "✅ Supergraph schemas composed successfully:"
              - "  - {{ output_dir }}/supergraph-admin.graphql"
              - "  - {{ output_dir }}/supergraph-storefront.graphql"

      rescue:
        - name: Show error details
          ansible.builtin.debug:
            msg:
              - "❌ Schema composition failed!"
              - "Task: {{ ansible_failed_task.name | default('Unknown') }}"
              - "Error: {{ ansible_failed_result.msg | default('No message') }}"

        - name: Fail with message
          ansible.builtin.fail:
            msg: "Schema composition failed. See error details above."
