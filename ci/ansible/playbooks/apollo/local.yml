# ansible-playbook playbooks/apollo/local.yml
---
- name: Build and deploy Apollo Router services locally
  hosts: localhost
  connection: local
  become: false
  gather_facts: false

  vars:
    # Local build directory
    local_build_dir: "{{ playbook_dir }}/../../../../"

    # Apollo configuration paths
    apollo_dir: "{{ local_build_dir }}/apollo"
    runtime_dir: "{{ local_build_dir }}/ci/images/apollo/runtime"

    # Image configuration with 'local' tag
    rover_app_name: shopana/apollo-rover
    rover_image_tag: local
    rover_image_name: "{{ rover_app_name }}:{{ rover_image_tag }}"
    rover_build_context: "ci/images/apollo/rover"

    router_app_name: shopana/apollo-router
    router_image_tag: local
    router_image_name: "{{ router_app_name }}:{{ router_image_tag }}"
    router_build_context: "ci/images/apollo/router"

    # Supergraph configuration
    admin_api_config_path: "{{ apollo_dir }}/admin-api/supergraph.yaml"
    admin_api_output_path: "{{ runtime_dir }}/supergraph-admin.graphql"

    storefront_api_config_path: "{{ apollo_dir }}/storefront-api/supergraph.yaml"
    storefront_api_output_path: "{{ runtime_dir }}/supergraph-storefront.graphql"

    # Docker compose
    compose_file: "{{ runtime_dir }}/docker-compose.yml"

  pre_tasks:
    - name: Include common pre-setup tasks
      ansible.builtin.include_tasks: "{{ playbook_dir }}/../../tasks/pre_setup.yml"

  tasks:
    - name: Display deployment start message
      ansible.builtin.debug:
        msg:
          - "ðŸš€ Starting local Apollo Router deployment"
          - "ðŸ“ Working directory: {{ local_build_dir }}"

    - name: Build block with error handling
      block:
        - name: Check if Rover image exists
          community.docker.docker_image_info:
            name: "{{ rover_image_name }}"
          register: rover_check
          ignore_errors: true

        - name: Display Rover image status
          ansible.builtin.debug:
            msg: "{{ 'âœ… Using existing Apollo Rover image: ' + rover_image_name if rover_check.images else 'ðŸ”¨ Building Apollo Rover image: ' + rover_image_name }}"

        - name: Build apollo-rover image if needed
          ansible.builtin.command:
            cmd: docker build -t {{ rover_image_name }} {{ rover_build_context }}
            chdir: "{{ local_build_dir }}"
          when: not rover_check.images
          changed_when: true

        - name: Check if Router image exists
          community.docker.docker_image_info:
            name: "{{ router_image_name }}"
          register: router_check
          ignore_errors: true

        - name: Display Router image status
          ansible.builtin.debug:
            msg: "{{ 'âœ… Using existing Apollo Router image: ' + router_image_name if router_check.images else 'ðŸ”¨ Building Apollo Router image: ' + router_image_name }}"

        - name: Build apollo-router image if needed
          ansible.builtin.command:
            cmd: docker build -t {{ router_image_name }} {{ router_build_context }}
            chdir: "{{ local_build_dir }}"
          when: not router_check.images
          changed_when: true

        - name: Compose Admin API supergraph schema
          ansible.builtin.command:
            cmd: >
              docker run --rm
              -e APOLLO_ELV2_LICENSE=accept
              -v "{{ admin_api_config_path }}:/workspace/supergraph.yaml"
              -v "{{ admin_api_output_path | dirname }}:/workspace/output"
              {{ rover_image_name }}
              supergraph compose
              --config /workspace/supergraph.yaml
          register: admin_compose_result
          changed_when: true
          failed_when: admin_compose_result.rc != 0

        - name: Save Admin API supergraph to file
          ansible.builtin.copy:
            content: "{{ admin_compose_result.stdout }}"
            dest: "{{ admin_api_output_path }}"
          changed_when: true

        - name: Display Admin API schema status
          ansible.builtin.debug:
            msg: "âœ… Admin API supergraph schema composed: {{ admin_api_output_path }}"

        - name: Compose Storefront API supergraph schema
          ansible.builtin.command:
            cmd: >
              docker run --rm
              -e APOLLO_ELV2_LICENSE=accept
              -v "{{ storefront_api_config_path }}:/workspace/supergraph.yaml"
              -v "{{ storefront_api_output_path | dirname }}:/workspace/output"
              {{ rover_image_name }}
              supergraph compose
              --config /workspace/supergraph.yaml
          register: storefront_compose_result
          changed_when: true
          failed_when: storefront_compose_result.rc != 0

        - name: Save Storefront API supergraph to file
          ansible.builtin.copy:
            content: "{{ storefront_compose_result.stdout }}"
            dest: "{{ storefront_api_output_path }}"
          changed_when: true

        - name: Display Storefront API schema status
          ansible.builtin.debug:
            msg: "âœ… Storefront API supergraph schema composed: {{ storefront_api_output_path }}"

        - name: Stop existing Apollo Router services
          community.docker.docker_compose_v2:
            project_src: "{{ runtime_dir }}"
            state: absent
          ignore_errors: true

        - name: Start Apollo Router services with Docker Compose
          community.docker.docker_compose_v2:
            project_src: "{{ runtime_dir }}"
            state: present
            pull: never
            recreate: always

        - name: Wait for Admin Router to be healthy
          ansible.builtin.uri:
            url: http://localhost:8088/health
            method: GET
            status_code: 200
          register: admin_health
          until: admin_health.status == 200
          retries: 30
          delay: 2
          ignore_errors: true

        - name: Wait for Storefront Router to be healthy
          ansible.builtin.uri:
            url: http://localhost:8089/health
            method: GET
            status_code: 200
          register: storefront_health
          until: storefront_health.status == 200
          retries: 30
          delay: 2
          ignore_errors: true

        - name: Show success message
          ansible.builtin.debug:
            msg:
              - "âœ… Apollo Router services deployed successfully!"
              - ""
              - "ðŸ“¦ Images:"
              - "  - {{ rover_image_name }}"
              - "  - {{ router_image_name }}"
              - ""
              - "ðŸ”— Services:"
              - "  - Admin API:      http://localhost:4000/api/admin/graphql/query"
              - "  - Admin Health:   http://localhost:8088/health"
              - "  - Storefront API: http://localhost:4001/api/client/graphql/query"
              - "  - Storefront Health: http://localhost:8089/health"
              - ""
              - "ðŸ“„ Schemas:"
              - "  - {{ admin_api_output_path }}"
              - "  - {{ storefront_api_output_path }}"

      rescue:
        - name: Show error details
          ansible.builtin.debug:
            msg:
              - "âŒ Deployment failed!"
              - "Task: {{ ansible_failed_task.name | default('Unknown') }}"
              - "Error: {{ ansible_failed_result.msg | default('No message') }}"
              - "{% if ansible_failed_result.stderr is defined and ansible_failed_result.stderr | length > 0 %}Stderr: {{ ansible_failed_result.stderr }}{% endif %}"

        - name: Stop services on failure
          community.docker.docker_compose_v2:
            project_src: "{{ runtime_dir }}"
            state: absent
          ignore_errors: true

        - name: Fail with message
          ansible.builtin.fail:
            msg: "Local deployment failed. See error details above."
