---
# Reusable tasks for exporting Apollo Federation subgraph schemas
# Required variables:
#   - project_root: Root directory of the project
#   - schema_dir: Directory where schemas will be exported

- name: Display export start message
  ansible.builtin.debug:
    msg:
      - "üì¶ Starting Apollo Federation subgraph schema export"
      - "üìÅ Output directory: {{ schema_dir }}"

- name: Ensure apollo schema output directory exists
  ansible.builtin.file:
    path: "{{ schema_dir }}"
    state: directory
    mode: "0755"

- name: Check if node_modules exists in apollo scripts directory
  ansible.builtin.stat:
    path: "{{ project_root }}/ci/apollo/node_modules"
  register: apollo_node_modules

- name: Install dependencies for apollo scripts
  ansible.builtin.command:
    cmd: yarn install
    chdir: "{{ project_root }}/ci/apollo"
  when: not apollo_node_modules.stat.exists
  changed_when: true

- name: Export all subgraph schemas using tsx
  ansible.builtin.command:
    cmd: yarn tsx scripts/build-schemas.js {{ schema_output_arg }}
    chdir: "{{ project_root }}/ci/apollo"
  register: export_result
  changed_when: true
  failed_when: export_result.rc != 0

- name: Display export output
  ansible.builtin.debug:
    msg: "{{ export_result.stdout_lines }}"

- name: Find all exported schema files
  ansible.builtin.find:
    paths: "{{ schema_dir }}"
    patterns: "*.graphql"
  register: exported_schemas

- name: Display exported schemas
  ansible.builtin.debug:
    msg:
      - "‚úÖ Successfully exported {{ exported_schemas.files | length }} schema(s):"
      - "{{ exported_schemas.files | map(attribute='path') | map('basename') | list }}"
