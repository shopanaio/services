# ansible-playbook playbooks/woodpecker-config-service/deploy.yml
---
- name: Install config-service on remote host from GHCR
  hosts: shopana
  become: true
  gather_facts: true

  vars:
    # Application configuration
    app_name: config-service
    app_dir: /opt/config-service
    app_data_dir: /opt/config-service/data
    container_port: 3000
    host_http_port: 3300

    # GHCR configuration
    shopana_ghcr_owner: "{{ lookup('env', 'SHOPANA_GHCR_OWNER') }}"
    shopana_github_token: "{{ lookup('env', 'SHOPANA_GITHUB_TOKEN') }}"
    config_service_image_tag: "{{ lookup('env', 'WOODPECKER_CONFIG_SERVICE_IMAGE_TAG') | default('latest', true) }}"
    config_service_image_name: "ghcr.io/{{ shopana_ghcr_owner }}/{{ app_name }}:{{ config_service_image_tag }}"
    config_service_github_api_token: "{{ lookup('env', 'WOODPECKER_CONFIG_SERVICE_GITHUB_API_TOKEN') }}"
    config_service_public_key_signature: "{{ lookup('env', 'WOODPECKER_CONFIG_SERVICE_PUBLIC_KEY') }}"

  tasks:
    - name: Validate required variables are provided
      ansible.builtin.assert:
        that:
          - shopana_ghcr_owner is defined and shopana_ghcr_owner | length > 0
          - shopana_github_token is defined and shopana_github_token | length > 0
          - config_service_github_api_token is defined and config_service_github_api_token | length > 0
          - config_service_public_key_signature is defined and config_service_public_key_signature | length > 0
        fail_msg: >-
          Required variables missing. Provide SHOPANA_GHCR_OWNER, SHOPANA_GITHUB_TOKEN,
          and WOODPECKER_CONFIG_SERVICE_GITHUB_API_TOKEN via environment or -e "VAR=...".
        success_msg: "All required variables are present"

    - name: Installation block with error handling
      block:
        - name: Show installation information
          ansible.builtin.debug:
            msg:
              - "üöÄ Installing {{ app_name }}"
              - "  Image: {{ config_service_image_name }}"
              - "  Port: {{ host_http_port }}"
              - "  Directory: {{ app_dir }}"

        - name: Ensure application directories exist on remote host
          ansible.builtin.file:
            path: "{{ item }}"
            state: directory
            mode: "0755"
          loop:
            - "{{ app_dir }}"
            - "{{ app_data_dir }}"
            - "{{ app_dir }}/workflows"

        # Removed step that tried to update a local public key file which may not exist

        - name: Login to GitHub Container Registry
          community.docker.docker_login:
            registry: ghcr.io
            username: "{{ shopana_ghcr_owner }}"
            password: "{{ shopana_github_token }}"
          no_log: true

        - name: Pull Docker image from GHCR
          community.docker.docker_image:
            name: "{{ config_service_image_name }}"
            source: pull
            force_source: true

        - name: Create public-key.pem file
          ansible.builtin.copy:
            dest: "{{ app_dir }}/public-key.pem"
            mode: "0644"
            content: |
              -----BEGIN PUBLIC KEY-----
              {{ config_service_public_key_signature }}
              -----END PUBLIC KEY-----

        - name: Stop and remove existing {{ app_name }} container if running
          community.docker.docker_container:
            name: "{{ app_name }}"
            state: absent
          ignore_errors: true

        - name: Wait for port to be released
          ansible.builtin.wait_for:
            port: "{{ host_http_port }}"
            state: stopped
            timeout: 30
          ignore_errors: true

        - name: Start {{ app_name }} container
          community.docker.docker_container:
            name: "{{ app_name }}"
            image: "{{ config_service_image_name }}"
            state: started
            restart_policy: unless-stopped
            ports:
              - "0.0.0.0:{{ host_http_port }}:{{ container_port }}"
            volumes:
              - "{{ app_dir }}/public-key.pem:/app/ci/woodpecker-config-service/public-key.pem:ro"
              - "{{ app_dir }}/workflows:/app/ci/woodpecker-config-service/workflows:ro"
            env:
              PORT: "{{ container_port }}"
              LOG_LEVEL: "debug"
              NODE_ENV: "production"
              WOODPECKER_GITHUB_TOKEN: "{{ config_service_github_api_token }}"
              CONFIG_SERVICE_PUBLIC_KEY_FILE: "public-key.pem"

        - name: Wait a moment for container to start
          ansible.builtin.pause:
            seconds: 3

        - name: Show startup logs
          ansible.builtin.command:
            cmd: docker logs {{ app_name }} --tail=30
          register: startup_logs
          changed_when: false

        - name: Display startup logs
          ansible.builtin.debug:
            var: startup_logs.stdout_lines

        - name: Wait for {{ app_name }} to listen on {{ host_http_port }}
          ansible.builtin.wait_for:
            host: 127.0.0.1
            port: "{{ host_http_port }}"
            delay: 2
            timeout: 60
          ignore_errors: true

        - name: Get container info
          community.docker.docker_container_info:
            name: "{{ app_name }}"
          register: container_info

        - name: Display container status
          ansible.builtin.debug:
            msg:
              - "Container: {{ app_name }}"
              - "Status: {{ container_info.container.State.Status }}"
              - "Running: {{ container_info.container.State.Running }}"
              - "Image: {{ container_info.container.Config.Image }}"

        - name: Show access info
          ansible.builtin.debug:
            msg:
              - "‚úÖ {{ app_name }} deployed"
              - ""
              - "üåê Service Info:"
              - "  Image: {{ config_service_image_name }}"
              - "  HTTP: http://{{ ansible_host }}:{{ host_http_port }}"
              - "  Health: http://{{ ansible_host }}:{{ host_http_port }}/healthz"
              - "  Dir: {{ app_dir }}"
              - "  Env: {{ app_dir }}/.env"
              - ""
              - "üìä View Logs:"
              - "  ansible-playbook playbooks/woodpecker-config-service/manage.yml -e 'action=logs'"
              - ""
              - "üîß Manage Service:"
              - "  ansible-playbook playbooks/woodpecker-config-service/manage.yml -e 'action=restart'"
              - "  ansible-playbook playbooks/woodpecker-config-service/manage.yml -e 'action=status'"
              - ""
              - "üßπ Cleanup Port:"
              - "  ansible-playbook playbooks/cleanup/cleanup-port.yml -e 'cleanup_port={{ host_http_port }}'"

      rescue:
        - name: Show error details
          ansible.builtin.debug:
            msg:
              - "‚ùå Installation failed!"
              - "Error: {{ ansible_failed_result.msg | default('Unknown error') }}"
              - ""
              - "Attempting to show current state..."

        - name: Get container info on error
          community.docker.docker_container_info:
            name: "{{ app_name }}"
          register: error_container_info
          ignore_errors: true

        - name: Display error container status
          ansible.builtin.debug:
            msg:
              - "Container: {{ app_name }}"
              - "Status: {{ error_container_info.container.State.Status | default('Not found') }}"
              - "Running: {{ error_container_info.container.State.Running | default(false) }}"
          when: error_container_info is defined

        - name: Show container logs on error
          ansible.builtin.command:
            cmd: docker logs {{ app_name }} --tail=50
          register: error_logs
          changed_when: false
          ignore_errors: true

        - name: Display error logs
          ansible.builtin.debug:
            var: error_logs.stdout_lines
          when: error_logs is defined and error_logs.stdout_lines is defined

        - name: Show recovery instructions
          ansible.builtin.debug:
            msg:
              - "üí° Recovery options:"
              - "  ‚Ä¢ Retry: ansible-playbook playbooks/woodpecker-config-service/deploy.yml"
              - "  ‚Ä¢ Check logs: ssh {{ ansible_host }} 'docker logs {{ app_name }}'"
              - "  ‚Ä¢ Stop container: ssh {{ ansible_host }} 'docker stop {{ app_name }}'"
              - "  ‚Ä¢ Clean install: ssh {{ ansible_host }} 'rm -rf {{ app_dir }}'"

        - name: Fail with message
          ansible.builtin.fail:
            msg: "Installation failed. See error details above."

      always:
        - name: Logout from GitHub Container Registry
          ansible.builtin.command:
            cmd: docker logout ghcr.io
          changed_when: false
          ignore_errors: true
