# Uninstall Monitoring Stack
# Usage: ansible-playbook playbooks/monitoring/uninstall.yml -i hosts.ini --limit shopana_sandbox
---
- name: Uninstall Monitoring Stack
  hosts: shopana_sandbox
  become: true

  vars:
    app_name: monitoring
    app_dir: /opt/shopana/monitoring

  tasks:
    - name: Check if deployment directory exists
      ansible.builtin.stat:
        path: "{{ app_dir }}"
      register: app_dir_stat

    - name: Uninstall block
      when: app_dir_stat.stat.exists
      block:
        - name: Show uninstall information
          ansible.builtin.debug:
            msg:
              - "üóëÔ∏è Uninstalling {{ app_name }} stack"
              - "  Directory: {{ app_dir }}"

        - name: Stop and remove containers
          ansible.builtin.command:
            cmd: docker compose down -v
            chdir: "{{ app_dir }}"
          ignore_errors: true
          changed_when: true

        - name: Remove Docker volumes
          ansible.builtin.command:
            cmd: "docker volume rm {{ item }}"
          loop:
            - shopana-grafana-data
            - shopana-prometheus-data
            - shopana-loki-data
            - shopana-promtail-positions
          ignore_errors: true
          changed_when: true

        - name: Remove deployment directory
          ansible.builtin.file:
            path: "{{ app_dir }}"
            state: absent

        - name: Show success message
          ansible.builtin.debug:
            msg:
              - "‚úÖ Monitoring stack uninstalled successfully"
              - "  All containers, volumes, and configurations have been removed"

    - name: Show already clean message
      ansible.builtin.debug:
        msg:
          - "‚ú® Monitoring stack is not installed"
          - "  Nothing to uninstall"
      when: not app_dir_stat.stat.exists
