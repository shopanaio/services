# NATS Server Configuration - {{ nats_env }}
# Generated by Ansible
# Documentation: https://docs.nats.io/running-a-nats-service/configuration

# Server name (useful in cluster mode)
server_name: $SERVER_NAME

# Network settings
port: 4222
http_port: 8222

# Client connection settings
max_connections: {{ nats_max_connections | default(64000) }}
max_control_line: {{ nats_max_control_line | default(4096) }}
max_payload: {{ nats_max_payload | default(10485760) }}  # 10MB

# Ping interval
ping_interval: "{{ nats_ping_interval | default('2m') }}"
ping_max: {{ nats_ping_max | default(2) }}

# Write deadline
write_deadline: "{{ nats_write_deadline | default('10s') }}"

# Max pending size for outbound messages
max_pending_size: {{ nats_max_pending_size | default(67108864) }}  # 64MB

{% if nats_enable_tls | default(false) %}
# TLS Configuration
tls {
  cert_file: "{{ nats_tls_cert }}"
  key_file: "{{ nats_tls_key }}"
  ca_file: "{{ nats_tls_ca }}"
  verify: true
}
{% endif %}

# Authentication
authorization {
  # Default permissions for all users
  default_permissions {
    publish = {
      allow = ["app.v1.>", "moleculer.>", "shopana.>"]
    }
    subscribe = {
      allow = ["app.v1.>", "moleculer.>", "shopana.>", "_INBOX.>"]
    }
  }

  # Users
  users = [
    {
      user: $NATS_USER
      password: $NATS_PASSWORD
    }
  ]
}

# JetStream configuration
jetstream {
  # Storage directory
  store_dir: "/data/jetstream"

  # Maximum memory and storage for JetStream
  max_memory_store: {{ nats_jetstream_max_memory | default('1GB') }}
  max_file_store: {{ nats_jetstream_max_file | default('10GB') }}

  # Sync interval for file store
  sync_interval: "{{ nats_jetstream_sync_interval | default('2m') }}"
}

# System account for monitoring and management
system_account: $SYS

# Accounts (for isolation between environments)
accounts {
  # System account
  $SYS {
    users = [
      { user: admin, password: $NATS_ADMIN_PASSWORD }
    ]
  }

  # Application account
  APP {
    jetstream: enabled
    users = [
      { user: $NATS_USER, password: $NATS_PASSWORD }
    ]
  }
}

# Logging
debug: {{ nats_debug | default(false) | lower }}
trace: {{ nats_trace | default(false) | lower }}
logtime: true
log_file: "/var/log/nats/nats-server.log"
log_size_limit: {{ nats_log_size_limit | default('100MB') }}
max_traced_msg_len: {{ nats_max_traced_msg_len | default(1024) }}

# Monitoring
http: 8222

# Monitoring endpoints:
# - http://{{ ansible_host }}:{{ nats_http_port }}/varz       - General server stats
# - http://{{ ansible_host }}:{{ nats_http_port }}/connz      - Connection details
# - http://{{ ansible_host }}:{{ nats_http_port }}/routez     - Route details
# - http://{{ ansible_host }}:{{ nats_http_port }}/subsz      - Subscription details
# - http://{{ ansible_host }}:{{ nats_http_port }}/jsz        - JetStream stats
# - http://{{ ansible_host }}:{{ nats_http_port }}/healthz    - Health check

{% if nats_enable_clustering | default(false) %}
# Clustering (for high availability)
cluster {
  name: {{ nats_cluster_name | default('shopana_cluster') }}
  listen: 0.0.0.0:6222

  # Routes to other servers
  routes = [
    {% for route in nats_cluster_routes | default([]) %}
    nats://{{ route }}:6222
    {% endfor %}
  ]

  # Cluster authentication
  authorization {
    user: $CLUSTER_USER
    password: $CLUSTER_PASSWORD
    timeout: 2
  }
}
{% endif %}

{% if nats_enable_leafnode | default(false) %}
# Leafnode connections (for hybrid cloud setup)
leafnodes {
  listen: 0.0.0.0:7422
  authorization {
    user: $LEAFNODE_USER
    password: $LEAFNODE_PASSWORD
  }
}
{% endif %}

{% if nats_enable_gateway | default(false) %}
# Gateway connections (for multi-region)
gateway {
  name: "{{ nats_gateway_name | default('region-eu') }}"
  listen: "0.0.0.0:7522"

  gateways: [
    {% for gw in nats_gateway_peers | default([]) %}
    {
      name: "{{ gw.name }}"
      urls: ["nats://{{ gw.url }}:7522"]
    }
    {% endfor %}
  ]
}
{% endif %}

# Limits
limits {
  # Maximum subscriptions per connection
  max_subscriptions: {{ nats_max_subscriptions | default(1000) }}

  # Maximum number of accounts
  max_accounts: {{ nats_max_accounts | default(10) }}

  # Maximum number of control line
  max_control_line: {{ nats_max_control_line | default(4096) }}
}
