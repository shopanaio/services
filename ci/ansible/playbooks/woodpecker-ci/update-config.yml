# Update Woodpecker CI configuration and restart
# ansible-playbook playbooks/woodpecker-ci/update-config.yml
# or with extra vars:
# ansible-playbook playbooks/woodpecker-ci/update-config.yml -e "woodpecker_host=https://ci.example.com" -e "woodpecker_admin=username"
---
- name: Update Woodpecker CI configuration
  hosts: shopana
  become: true
  gather_facts: true

  vars:
    woodpecker_dir: /opt/woodpecker
    woodpecker_data_dir: /opt/woodpecker/data
    # These can be overridden via extra vars
    wp_host: "{{ woodpecker_host | default('', true) }}"
    wp_admin: "{{ woodpecker_admin | default('', true) }}"
    wp_github_client: "{{ woodpecker_github_client | default('', true) }}"
    wp_github_secret: "{{ woodpecker_github_secret | default('', true) }}"
    wp_agent_secret: "{{ woodpecker_agent_secret | default('', true) }}"

  pre_tasks:
    - name: Include common pre-setup tasks
      ansible.builtin.include_tasks: "{{ playbook_dir }}/../../tasks/pre_setup.yml"

  tasks:
    - name: Verify Woodpecker directory exists
      ansible.builtin.stat:
        path: "{{ woodpecker_dir }}/docker-compose.yml"
      register: compose_file

    - name: Fail if Woodpecker is not installed
      ansible.builtin.fail:
        msg: "Woodpecker is not installed at {{ woodpecker_dir }}. Run playbooks/woodpecker-ci/install.yml first."
      when: not compose_file.stat.exists

    - name: Check if .env file exists
      ansible.builtin.stat:
        path: "{{ woodpecker_dir }}/.env"
      register: env_file

    - name: Read current .env file
      ansible.builtin.slurp:
        src: "{{ woodpecker_dir }}/.env"
      register: current_env
      when: env_file.stat.exists

    - name: Parse current environment variables
      ansible.builtin.set_fact:
        current_config: "{{ (current_env.content | b64decode).split('\n') | select('match', '^[A-Z_]+=.*') | list }}"
      when: env_file.stat.exists

    - name: Display current configuration
      ansible.builtin.debug:
        msg:
          - "Current Woodpecker configuration:"
          - "{{ current_config | default(['No configuration found']) }}"
      when: env_file.stat.exists

    - name: Display new values to be set
      ansible.builtin.debug:
        msg:
          - "New configuration values:"
          - "WOODPECKER_HOST: {{ wp_host if wp_host else '(not changed)' }}"
          - "WOODPECKER_ADMIN: {{ wp_admin if wp_admin else '(not changed)' }}"
          - "WOODPECKER_GITHUB_CLIENT: {{ wp_github_client if wp_github_client else '(not changed)' }}"
          - "WOODPECKER_GITHUB_SECRET: {{ '***' if wp_github_secret else '(not changed)' }}"
          - "WOODPECKER_AGENT_SECRET: {{ '***' if wp_agent_secret else '(not changed)' }}"

    - name: Backup current .env file
      ansible.builtin.copy:
        src: "{{ woodpecker_dir }}/.env"
        dest: "{{ woodpecker_dir }}/.env.backup.{{ ansible_date_time.epoch }}"
        remote_src: true
        mode: '0600'
      when: env_file.stat.exists

    - name: Read existing .env to preserve unset values
      ansible.builtin.slurp:
        src: "{{ woodpecker_dir }}/.env"
      register: existing_env
      when: env_file.stat.exists

    - name: Extract existing values from .env
      ansible.builtin.set_fact:
        existing_host: "{{ (existing_env.content | b64decode) | regex_search('^WOODPECKER_HOST=(.*)$', '\\1', multiline=True) | default('', true) }}"
        existing_admin: "{{ (existing_env.content | b64decode) | regex_search('^WOODPECKER_ADMIN=(.*)$', '\\1', multiline=True) | default('', true) }}"
        existing_agent_secret: "{{ (existing_env.content | b64decode) | regex_search('^WOODPECKER_AGENT_SECRET=(.*)$', '\\1', multiline=True) | default('', true) }}"
        existing_github_client: "{{ (existing_env.content | b64decode) | regex_search('^WOODPECKER_GITHUB_CLIENT=(.*)$', '\\1', multiline=True) | default('', true) }}"
        existing_github_secret: "{{ (existing_env.content | b64decode) | regex_search('^WOODPECKER_GITHUB_SECRET=(.*)$', '\\1', multiline=True) | default('', true) }}"
      when: env_file.stat.exists

    - name: Set merged values (prefer provided > existing > defaults)
      ansible.builtin.set_fact:
        merged_host: "{{ wp_host | default(existing_host, true) | default('https://ci.example.com', true) }}"
        merged_admin: "{{ wp_admin | default(existing_admin, true) | default('', true) }}"
        merged_agent_secret: "{{ wp_agent_secret | default(existing_agent_secret, true) | default('', true) }}"
        merged_github_client: "{{ wp_github_client | default(existing_github_client, true) | default('', true) }}"
        merged_github_secret: "{{ wp_github_secret | default(existing_github_secret, true) | default('', true) }}"
      when: env_file.stat.exists

    - name: Update Woodpecker environment file
      ansible.builtin.copy:
        dest: "{{ woodpecker_dir }}/.env"
        mode: '0600'
        content: |
          # Woodpecker CI Configuration
          # Updated at: {{ ansible_date_time.iso8601 }}
          # Server URL (should be accessible from outside)
          WOODPECKER_HOST={{ merged_host | default(wp_host) | default('https://ci.example.com') }}

          # Admin users (comma-separated list of GitHub usernames)
          WOODPECKER_ADMIN={{ merged_admin | default(wp_admin) | default('') }}

          # Agent secret (shared between server and agents)
          WOODPECKER_AGENT_SECRET={{ merged_agent_secret | default(wp_agent_secret) | default('') }}

          # GitHub OAuth Configuration
          WOODPECKER_GITHUB_CLIENT={{ merged_github_client | default(wp_github_client) | default('') }}
          WOODPECKER_GITHUB_SECRET={{ merged_github_secret | default(wp_github_secret) | default('') }}

    - name: Stop Woodpecker CI
      ansible.builtin.command:
        cmd: docker compose down
        chdir: "{{ woodpecker_dir }}"
      changed_when: true

    - name: Start Woodpecker CI with new configuration
      ansible.builtin.command:
        cmd: docker compose up -d
        chdir: "{{ woodpecker_dir }}"
      changed_when: true

    - name: Wait for Woodpecker to be ready
      ansible.builtin.wait_for:
        port: 8000
        delay: 5
        timeout: 60
      ignore_errors: true

    - name: Get Woodpecker status
      ansible.builtin.command:
        cmd: docker compose ps
        chdir: "{{ woodpecker_dir }}"
      register: status_output
      changed_when: false

    - name: Display Woodpecker status
      ansible.builtin.debug:
        var: status_output.stdout_lines

    - name: Display success message
      ansible.builtin.debug:
        msg:
          - "âœ… Woodpecker CI configuration updated and restarted!"
          - ""
          - "Access Woodpecker at: http://{{ ansible_host }}:8000"
          - "Or via configured domain: {{ merged_host | default(wp_host) | default('https://ci.example.com') }}"
          - ""
          - "Backup created: {{ woodpecker_dir }}/.env.backup.{{ ansible_date_time.epoch }}"
          - "Configuration file: {{ woodpecker_dir }}/.env"
          - ""
          - "To view logs: ansible-playbook playbooks/woodpecker-ci/manage.yml -e 'action=logs'"
          - "To check status: ansible-playbook playbooks/woodpecker-ci/manage.yml -e 'action=status'"
