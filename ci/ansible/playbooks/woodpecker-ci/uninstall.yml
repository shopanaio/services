# ansible-playbook playbooks/woodpecker-ci/uninstall.yml
---
- name: Uninstall Woodpecker CI from remote host
  hosts: shopana
  become: true
  gather_facts: true

  vars:
    woodpecker_dir: /opt/woodpecker
    woodpecker_data_dir: /opt/woodpecker/data
    remove_images: true
    remove_data: true
    remove_project_dir: true

  pre_tasks:
    - name: Include common pre-setup tasks
      ansible.builtin.include_tasks: "{{ playbook_dir }}/../../tasks/pre_setup.yml"

  tasks:
    - name: Check if Woodpecker directory exists
      ansible.builtin.stat:
        path: "{{ woodpecker_dir }}"
      register: woodpecker_dir_stat

    - name: Display current Woodpecker status before removal
      ansible.builtin.command:
        cmd: docker compose ps
        chdir: "{{ woodpecker_dir }}"
      register: pre_removal_status
      when: woodpecker_dir_stat.stat.exists
      changed_when: false
      ignore_errors: true

    - name: Show current Woodpecker containers
      ansible.builtin.debug:
        msg: "{{ pre_removal_status.stdout_lines }}"
      when:
        - woodpecker_dir_stat.stat.exists
        - pre_removal_status is succeeded

    - name: Stop and remove services with Compose v2 (module)
      community.docker.docker_compose_v2:
        project_src: "{{ woodpecker_dir }}"
        state: absent
      when: woodpecker_dir_stat.stat.exists
      register: compose_absent_result
      ignore_errors: true

    - name: Fallback - Stop and remove with docker compose down -v --remove-orphans
      ansible.builtin.command:
        cmd: docker compose down -v --remove-orphans
        chdir: "{{ woodpecker_dir }}"
      when:
        - woodpecker_dir_stat.stat.exists
        - compose_absent_result is failed
      changed_when: true
      ignore_errors: true

    - name: Ensure containers are removed explicitly
      community.docker.docker_container:
        name: "{{ item }}"
        state: absent
        force_kill: true
      loop:
        - woodpecker-server
        - woodpecker-agent
      ignore_errors: true

    - name: Remove Woodpecker docker network if exists
      community.docker.docker_network:
        name: woodpecker
        state: absent
      ignore_errors: true

    - name: Remove Woodpecker images (server and agent)
      community.docker.docker_image:
        name: "{{ item }}"
        state: absent
        force_absent: true
      loop:
        - woodpeckerci/woodpecker-server
        - woodpeckerci/woodpecker-agent
      when: remove_images
      ignore_errors: true

    - name: Remove data directory
      ansible.builtin.file:
        path: "{{ woodpecker_data_dir }}"
        state: absent
      when: remove_data

    - name: Remove project directory (includes compose and env files)
      ansible.builtin.file:
        path: "{{ woodpecker_dir }}"
        state: absent
      when: remove_project_dir

    - name: Verify containers are removed
      ansible.builtin.command:
        cmd: docker ps -a --filter "name=woodpecker" --format "table {% raw %}{{.Names}}\t{{.Status}}{% endraw %}"
      register: remaining_containers
      changed_when: false
      ignore_errors: true

    - name: Verify networks are removed
      ansible.builtin.command:
        cmd: docker network ls --filter "name=woodpecker" --format "table {% raw %}{{.Name}}\t{{.Driver}}{% endraw %}"
      register: remaining_networks
      changed_when: false
      ignore_errors: true

    - name: Display uninstall status
      ansible.builtin.debug:
        msg:
          - "âœ… Woodpecker CI has been removed from host {{ inventory_hostname }}"
          - ""
          - "Removed components:"
          - "  - Images: {{ remove_images }}"
          - "  - Data directory: {{ remove_data }} ({{ woodpecker_data_dir }})"
          - "  - Project directory: {{ remove_project_dir }} ({{ woodpecker_dir }})"
          - ""
          - "Remaining containers: {{ remaining_containers.stdout_lines | length - 1 if remaining_containers.stdout_lines | length > 1 else 0 }}"
          - "Remaining networks: {{ remaining_networks.stdout_lines | length - 1 if remaining_networks.stdout_lines | length > 1 else 0 }}"
          - ""
          - "To clean up unused Docker resources, run:"
          - "  docker system prune -a --volumes"
