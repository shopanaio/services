---
# Pre-setup tasks that run before all playbooks
# This file is included via pre_tasks in playbooks
#
# Automatically loads environment variables from .env file if it exists
# Variables are available via ansible_env_vars dict
#
# Usage:
#   ansible-playbook playbooks/xxx.yml
#
# .env file location: ci/ansible/.env (see env.example)

- name: Display pre-setup start
  ansible.builtin.debug:
    msg: "üîß Running pre-playbook setup..."
  tags: always

- name: Check if .env file exists
  ansible.builtin.stat:
    path: "{{ playbook_dir }}/../../ansible/.env"
  register: env_file_stat
  delegate_to: localhost
  run_once: true
  tags: always

- name: Read .env file content
  ansible.builtin.slurp:
    src: "{{ playbook_dir }}/../../ansible/.env"
  register: env_file_content
  when: env_file_stat.stat.exists
  delegate_to: localhost
  run_once: true
  tags: always

- name: Parse .env file and set variables
  ansible.builtin.set_fact:
    ansible_env_vars: "{{ ansible_env_vars | default({}) | combine({item.split('=')[0]: item.split('=', 1)[1]}) }}"
  loop: "{{ (env_file_content.content | b64decode).split('\n') }}"
  when:
    - env_file_stat.stat.exists
    - item is defined
    - item | length > 0
    - not item.strip().startswith('#')
    - "'=' in item"
  delegate_to: localhost
  run_once: true
  no_log: true
  tags: always

- name: Display loaded variables count
  ansible.builtin.debug:
    msg: "‚úì Loaded {{ ansible_env_vars | default({}) | length }} variables from .env file"
  when: env_file_stat.stat.exists
  delegate_to: localhost
  run_once: true
  tags: always

- name: Display warning if .env file not found
  ansible.builtin.debug:
    msg:
      - "‚ö†Ô∏è  No .env file found at: {{ playbook_dir }}/../../ansible/.env"
      - ""
      - "üí° To create .env file:"
      - "   cd ci/ansible"
      - "   cp env.example .env"
      - "   vim .env  # Set your values"
      - ""
      - "Will use environment variables or defaults instead."
  when: not env_file_stat.stat.exists
  delegate_to: localhost
  run_once: true
  tags: always

- name: Verify pre-setup completion
  ansible.builtin.debug:
    msg: "‚úÖ Pre-setup completed"
  tags: always
