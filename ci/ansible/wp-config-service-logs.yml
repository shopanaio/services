# Quick access to config-service logs
#
# Show last 100 lines:
#   ansible-playbook wp-config-service-logs.yml
#
# Show last 500 lines:
#   ansible-playbook wp-config-service-logs.yml -e "lines=500"
#
# Follow logs in real-time (Ctrl+C to exit):
#   ansible-playbook wp-config-service-logs.yml -e "follow=true"
#
---
- name: View config-service logs
  hosts: shopana
  become: true
  gather_facts: false

  vars:
    # Application configuration
    app_name: config-service
    app_dir: /opt/config-service

    # Log parameters
    lines: 100
    follow: false

  tasks:
    - name: Verify service is installed
      ansible.builtin.stat:
        path: "{{ app_dir }}/docker-compose.yml"
      register: compose_file

    - name: Fail if not installed
      ansible.builtin.fail:
        msg: "{{ app_name }} is not installed at {{ app_dir }}"
      when: not compose_file.stat.exists

    - name: Show service status first
      ansible.builtin.debug:
        msg: "ðŸ“Š Service Status:"

    - name: Get service status
      ansible.builtin.command:
        cmd: docker compose ps
        chdir: "{{ app_dir }}"
      register: service_status
      changed_when: false

    - name: Display service status
      ansible.builtin.debug:
        var: service_status.stdout_lines

    - name: Show logs header
      ansible.builtin.debug:
        msg: "ðŸ“‹ Last {{ lines }} log lines:"
      when: not follow | bool

    - name: Show logs (static)
      ansible.builtin.command:
        cmd: docker compose logs --tail={{ lines }}
        chdir: "{{ app_dir }}"
      register: static_logs
      changed_when: false
      when: not follow | bool

    - name: Display logs (static)
      ansible.builtin.debug:
        var: static_logs.stdout_lines
      when: not follow | bool

    - name: Follow logs in real-time (press Ctrl+C to exit)
      ansible.builtin.shell:
        cmd: docker compose logs --tail={{ lines }} --follow
        chdir: "{{ app_dir }}"
      changed_when: false
      when: follow | bool
