# ansible-playbook wp-config-service-install.yml
---
- name: Install config-service on remote host from GHCR
  hosts: shopana
  become: true
  gather_facts: true

  vars:
    # Application configuration
    app_name: config-service
    app_dir: /opt/config-service
    app_data_dir: /opt/config-service/data
    container_port: 3000
    host_http_port: 3300

    # GHCR configuration
    ghcr_registry: ghcr.io
    ghcr_owner: "{{ lookup('env', 'SHOPANA_GHCR_OWNER') }}"
    image_tag: "{{ lookup('env', 'WOODPECKER_CONFIG_SERVICE_IMAGE_TAG') | default('latest', true) }}"
    full_image_name: "{{ ghcr_registry }}/{{ ghcr_owner }}/{{ app_name }}:{{ image_tag }}"

    # Authentication tokens
    github_token: "{{ lookup('env', 'SHOPANA_GITHUB_TOKEN') }}"
    config_service_token: "{{ lookup('env', 'WOODPECKER_CONFIG_SERVICE_GITHUB_API_TOKEN') }}"
    config_service_public_key: "{{ lookup('env', 'WOODPECKER_CONFIG_SERVICE_PUBLIC_KEY') }}"


  tasks:
    - name: Validate required variables are provided
      ansible.builtin.assert:
        that:
          - ghcr_owner is defined and ghcr_owner | length > 0
          - github_token is defined and github_token | length > 0
          - config_service_token is defined and config_service_token | length > 0
          - config_service_public_key is defined and config_service_public_key | length > 0
        fail_msg: >-
          Required variables missing. Provide SHOPANA_GHCR_OWNER, SHOPANA_GITHUB_TOKEN,
          and WOODPECKER_CONFIG_SERVICE_GITHUB_API_TOKEN via environment or -e "VAR=...".
        success_msg: "All required variables are present"

    - name: Installation block with error handling
      block:
        - name: Show installation information
          ansible.builtin.debug:
            msg:
              - "üöÄ Installing {{ app_name }}"
              - "  Image: {{ full_image_name }}"
              - "  Port: {{ host_http_port }}"
              - "  Directory: {{ app_dir }}"

        - name: Ensure application directories exist on remote host
          ansible.builtin.file:
            path: "{{ item }}"
            state: directory
            mode: '0755'
          loop:
            - "{{ app_dir }}"
            - "{{ app_data_dir }}"

        # Removed step that tried to update a local public key file which may not exist

        - name: Login and pull Docker image from GHCR
          ansible.builtin.shell: |
            echo "{{ github_token }}" | docker login {{ ghcr_registry }} -u {{ ghcr_owner }} --password-stdin
            docker pull {{ full_image_name }}
          no_log: true
          changed_when: true

        - name: Create docker-compose.yml for {{ app_name }}
          ansible.builtin.copy:
            dest: "{{ app_dir }}/docker-compose.yml"
            mode: '0644'
            content: |
              services:
                {{ app_name }}:
                  image: {{ full_image_name }}
                  container_name: {{ app_name }}
                  restart: unless-stopped
                  ports:
                    - "0.0.0.0:{{ host_http_port }}:{{ container_port }}"
                  volumes:
                    - "{{ app_dir }}/public-key.pem:/app/ci/config-service/public-key.pem:ro"
                  environment:
                    - PORT={{ container_port }}
                    - LOG_LEVEL=debug
                    - NODE_ENV=production
                    - WOODPECKER_GITHUB_TOKEN=${WOODPECKER_CONFIG_SERVICE_GITHUB_API_TOKEN}
                    - CONFIG_SERVICE_PUBLIC_KEY_FILE=${CONFIG_SERVICE_PUBLIC_KEY_FILE}
                    # Signature verification enabled with public key
                    # Only GitHub is supported

        - name: Create .env for {{ app_name }}
          ansible.builtin.copy:
            dest: "{{ app_dir }}/.env"
            mode: '0600'
            content: |
              # {{ app_name }} configuration
              WOODPECKER_CONFIG_SERVICE_GITHUB_API_TOKEN={{ config_service_token }}
              # Hardcoded relative path to PEM inside working directory
              CONFIG_SERVICE_PUBLIC_KEY_FILE=public-key.pem
              # Only GitHub is supported

        - name: Create public-key.pem file
          ansible.builtin.copy:
            dest: "{{ app_dir }}/public-key.pem"
            mode: '0644'
            content: |
              -----BEGIN PUBLIC KEY-----
              {{ config_service_public_key }}
              -----END PUBLIC KEY-----

        - name: Cleanup containers on port {{ host_http_port }}
          ansible.builtin.include_tasks: cleanup-port-task.yml
          vars:
            cleanup_port: "{{ host_http_port }}"

        - name: Stop and remove existing {{ app_name }} container if running
          ansible.builtin.command:
            cmd: docker compose down
            chdir: "{{ app_dir }}"
          ignore_errors: true
          changed_when: true

        - name: Wait for port to be released
          ansible.builtin.wait_for:
            port: "{{ host_http_port }}"
            state: stopped
            timeout: 30
          ignore_errors: true

        - name: Additional pause to ensure cleanup
          ansible.builtin.pause:
            seconds: 2

        - name: Start {{ app_name }}
          ansible.builtin.command:
            cmd: docker compose up -d
            chdir: "{{ app_dir }}"
          changed_when: true

        - name: Wait a moment for container to start
          ansible.builtin.pause:
            seconds: 3

        - name: Show startup logs
          ansible.builtin.command:
            cmd: docker compose logs --tail=30
            chdir: "{{ app_dir }}"
          register: startup_logs
          changed_when: false

        - name: Display startup logs
          ansible.builtin.debug:
            var: startup_logs.stdout_lines

        - name: Wait for {{ app_name }} to listen on {{ host_http_port }}
          ansible.builtin.wait_for:
            host: 127.0.0.1
            port: "{{ host_http_port }}"
            delay: 2
            timeout: 60
          ignore_errors: true

        - name: Update public key in container
          ansible.builtin.shell: |
            docker exec {{ app_name }} sh -lc "sed -i 's/\\*\\*\\*/{{ config_service_public_key }}/g' /app/ci/config-service/public-key.pem || true"
          changed_when: true
          ignore_errors: true

        - name: Restart container to apply changes
          ansible.builtin.command:
            cmd: docker compose restart
            chdir: "{{ app_dir }}"
          changed_when: true

        - name: Show container status
          ansible.builtin.command:
            cmd: docker compose ps
            chdir: "{{ app_dir }}"
          register: compose_ps
          changed_when: false

        - name: Display status
          ansible.builtin.debug:
            var: compose_ps.stdout_lines

        - name: Show access info
          ansible.builtin.debug:
            msg:
              - "‚úÖ {{ app_name }} deployed"
              - ""
              - "üåê Service Info:"
              - "  Image: {{ full_image_name }}"
              - "  HTTP: http://{{ ansible_host }}:{{ host_http_port }}"
              - "  Health: http://{{ ansible_host }}:{{ host_http_port }}/healthz"
              - "  Dir: {{ app_dir }}"
              - "  Env: {{ app_dir }}/.env"
              - ""
              - "üìä View Logs:"
              - "  ansible-playbook wp-config-service-logs.yml"
              - "  ansible-playbook wp-config-service-logs.yml -e 'follow=true'"
              - "  ansible-playbook wp-config-service-manage.yml -e 'action=logs'"
              - ""
              - "üîß Manage Service:"
              - "  ansible-playbook wp-config-service-manage.yml -e 'action=restart'"
              - "  ansible-playbook wp-config-service-manage.yml -e 'action=status'"
              - ""
              - "üßπ Cleanup Port:"
              - "  ansible-playbook cleanup-port.yml -e 'cleanup_port={{ host_http_port }}'"

      rescue:
        - name: Show error details
          ansible.builtin.debug:
            msg:
              - "‚ùå Installation failed!"
              - "Error: {{ ansible_failed_result.msg | default('Unknown error') }}"
              - ""
              - "Attempting to show current state..."

        - name: Show container status on error
          ansible.builtin.command:
            cmd: docker compose ps
            chdir: "{{ app_dir }}"
          register: error_compose_ps
          changed_when: false
          ignore_errors: true

        - name: Display error container status
          ansible.builtin.debug:
            var: error_compose_ps.stdout_lines
          when: error_compose_ps is defined

        - name: Show container logs on error
          ansible.builtin.command:
            cmd: docker compose logs --tail=50
            chdir: "{{ app_dir }}"
          register: error_logs
          changed_when: false
          ignore_errors: true

        - name: Display error logs
          ansible.builtin.debug:
            var: error_logs.stdout_lines
          when: error_logs is defined and error_logs.stdout_lines is defined

        - name: Show recovery instructions
          ansible.builtin.debug:
            msg:
              - "üí° Recovery options:"
              - "  ‚Ä¢ Retry: ansible-playbook wp-config-service-install.yml"
              - "  ‚Ä¢ Clean port: ansible-playbook cleanup-port.yml -e 'cleanup_port={{ host_http_port }}'"
              - "  ‚Ä¢ Check logs: ssh {{ ansible_host }} 'cd {{ app_dir }} && docker compose logs'"
              - "  ‚Ä¢ Clean install: ssh {{ ansible_host }} 'rm -rf {{ app_dir }}'"

        - name: Fail with message
          ansible.builtin.fail:
            msg: "Installation failed. See error details above."

      always:
        - name: Logout from GitHub Container Registry
          ansible.builtin.command:
            cmd: docker logout {{ ghcr_registry }}
          changed_when: false
          ignore_errors: true
