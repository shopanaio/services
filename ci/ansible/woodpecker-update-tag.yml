# Update Woodpecker CI to version 3.10.0
# ansible-playbook woodpecker-update-tag.yml
---
- name: Update Woodpecker CI to version 3.10.0
  hosts: shopana
  become: true
  gather_facts: true

  vars:
    woodpecker_dir: /opt/woodpecker
    woodpecker_version: "v3.10.0"

  tasks:
    - name: Verify Woodpecker directory exists
      ansible.builtin.stat:
        path: "{{ woodpecker_dir }}/docker-compose.yml"
      register: compose_file

    - name: Fail if Woodpecker is not installed
      ansible.builtin.fail:
        msg: "Woodpecker is not installed at {{ woodpecker_dir }}. Run install-woodpecker.yml first."
      when: not compose_file.stat.exists

    - name: Read current docker-compose.yml
      ansible.builtin.slurp:
        src: "{{ woodpecker_dir }}/docker-compose.yml"
      register: current_compose

    - name: Display current docker-compose.yml
      ansible.builtin.debug:
        msg: "Current docker-compose.yml will be updated with version {{ woodpecker_version }}"

    - name: Backup current docker-compose.yml
      ansible.builtin.copy:
        src: "{{ woodpecker_dir }}/docker-compose.yml"
        dest: "{{ woodpecker_dir }}/docker-compose.yml.backup.{{ ansible_date_time.epoch }}"
        remote_src: true
        mode: '0644'

    - name: Read data directory path from compose file
      ansible.builtin.set_fact:
        woodpecker_data_dir: "{{ (current_compose.content | b64decode) | regex_search('- ([^:]+):/var/lib/woodpecker', '\\1') | first | default('/opt/woodpecker/data', true) }}"

    - name: Update Woodpecker docker-compose file with new version
      ansible.builtin.copy:
        dest: "{{ woodpecker_dir }}/docker-compose.yml"
        mode: '0644'
        content: |
          version: '3'

          services:
            woodpecker-server:
              image: woodpeckerci/woodpecker-server:{{ woodpecker_version }}
              container_name: woodpecker-server
              restart: unless-stopped
              ports:
                - "80:8000"
                - "9000:9000"
              volumes:
                - {{ woodpecker_data_dir }}:/var/lib/woodpecker/
              environment:
                - WOODPECKER_OPEN=true
                - WOODPECKER_HOST=${WOODPECKER_HOST}
                - WOODPECKER_AGENT_SECRET=${WOODPECKER_AGENT_SECRET}
                - WOODPECKER_ADMIN=${WOODPECKER_ADMIN}
                # GitHub OAuth configuration
                - WOODPECKER_GITHUB=true
                - WOODPECKER_GITHUB_CLIENT=${WOODPECKER_GITHUB_CLIENT}
                - WOODPECKER_GITHUB_SECRET=${WOODPECKER_GITHUB_SECRET}
              networks:
                - woodpecker

            woodpecker-agent:
              image: woodpeckerci/woodpecker-agent:{{ woodpecker_version }}
              container_name: woodpecker-agent
              restart: unless-stopped
              depends_on:
                - woodpecker-server
              volumes:
                - /var/run/docker.sock:/var/run/docker.sock
              environment:
                - WOODPECKER_SERVER=woodpecker-server:9000
                - WOODPECKER_AGENT_SECRET=${WOODPECKER_AGENT_SECRET}
                - WOODPECKER_MAX_WORKFLOWS=4
                - WOODPECKER_BACKEND=docker
              networks:
                - woodpecker

          networks:
            woodpecker:
              driver: bridge

    - name: Display update information
      ansible.builtin.debug:
        msg:
          - "Updating Woodpecker CI to version {{ woodpecker_version }}"
          - "Backup created: {{ woodpecker_dir }}/docker-compose.yml.backup.{{ ansible_date_time.epoch }}"

    - name: Pull new Woodpecker images (version {{ woodpecker_version }})
      ansible.builtin.command:
        cmd: docker compose pull
        chdir: "{{ woodpecker_dir }}"
      changed_when: true
      register: pull_result

    - name: Display pull result
      ansible.builtin.debug:
        var: pull_result.stdout_lines

    - name: Stop current Woodpecker containers
      ansible.builtin.command:
        cmd: docker compose down
        chdir: "{{ woodpecker_dir }}"
      changed_when: true

    - name: Start Woodpecker CI with new version
      ansible.builtin.command:
        cmd: docker compose up -d
        chdir: "{{ woodpecker_dir }}"
      changed_when: true

    - name: Wait for Woodpecker to be ready
      ansible.builtin.wait_for:
        port: 8000
        delay: 5
        timeout: 60
      ignore_errors: true

    - name: Get Woodpecker status
      ansible.builtin.command:
        cmd: docker compose ps
        chdir: "{{ woodpecker_dir }}"
      register: status_output
      changed_when: false

    - name: Display Woodpecker status
      ansible.builtin.debug:
        var: status_output.stdout_lines

    - name: Get Woodpecker version information
      ansible.builtin.command:
        cmd: docker compose images
        chdir: "{{ woodpecker_dir }}"
      register: images_output
      changed_when: false

    - name: Display Woodpecker images
      ansible.builtin.debug:
        var: images_output.stdout_lines

    - name: Check Woodpecker server version from container
      ansible.builtin.command:
        cmd: docker exec woodpecker-server sh -c 'woodpecker-server --version 2>/dev/null || /usr/local/bin/woodpecker-server --version 2>/dev/null || echo "Could not determine version"'
      register: server_version
      changed_when: false
      failed_when: false

    - name: Display success message
      ansible.builtin.debug:
        msg:
          - "âœ… Woodpecker CI successfully updated to version {{ woodpecker_version }} and restarted!"
          - ""
          - "Server version: {{ server_version.stdout | default('checking...') }}"
          - "Access Woodpecker at: http://{{ ansible_host }}"
          - ""
          - "Backup location: {{ woodpecker_dir }}/docker-compose.yml.backup.{{ ansible_date_time.epoch }}"
          - "Configuration file: {{ woodpecker_dir }}/.env"
          - ""
          - "To view logs: ansible-playbook manage-woodpecker.yml -e 'action=logs'"
          - "To check status: ansible-playbook manage-woodpecker.yml -e 'action=status'"
